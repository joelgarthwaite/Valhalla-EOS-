<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Valhalla Holdings - EOS Dashboard</title>
    <!-- Supabase Client Library -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root {
            --primary-dark: #121212;
            --accent-gold: #DFBD69;
            --forest-green: #1E352D;
            --success-green: #22C55E;
            --warning-amber: #F59E0B;
            --danger-red: #EF4444;
            --light-bg: #FAFAFA;
            --card-bg: #FFFFFF;
            --subtle-border: #E5E7EB;
            --text-secondary: #6B7280;
            --text-muted: #9CA3AF;
            --letter-spacing: 0.72px;
            --font-mono: 'SF Mono', 'Monaco', 'Consolas', monospace;
            --shadow-sm: 0 1px 2px rgba(0,0,0,0.05);
            --shadow-md: 0 4px 6px rgba(0,0,0,0.07);
            --shadow-lg: 0 10px 15px rgba(0,0,0,0.1);
            --transition: all 0.2s ease;
        }

        .dark-mode {
            --primary-dark: #FAFAFA;
            --light-bg: #121212;
            --card-bg: #1F1F1F;
            --subtle-border: #333333;
            --text-secondary: #9CA3AF;
            --text-muted: #6B7280;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--light-bg);
            color: var(--primary-dark);
            line-height: 1.6;
            min-height: 100vh;
        }

        h1, h2, h3, h4 {
            font-weight: 500;
            letter-spacing: var(--letter-spacing);
        }

        h1 { font-size: 2rem; }
        h2 { font-size: 1.5rem; }
        h3 { font-size: 1.25rem; }
        h4 { font-size: 1rem; }

        /* Layout */
        .app-container {
            display: flex;
            min-height: 100vh;
        }

        /* Sidebar */
        .sidebar {
            width: 260px;
            background: var(--card-bg);
            border-right: 1px solid var(--subtle-border);
            display: flex;
            flex-direction: column;
            position: fixed;
            height: 100vh;
            z-index: 100;
        }

        .sidebar-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--subtle-border);
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .logo-icon {
            width: 40px;
            height: 40px;
            background: var(--forest-green);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--accent-gold);
            font-weight: 700;
            font-size: 1.25rem;
        }

        .logo-text {
            font-size: 1.1rem;
            font-weight: 600;
            letter-spacing: var(--letter-spacing);
        }

        .logo-subtitle {
            font-size: 0.7rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .sidebar-nav {
            flex: 1;
            padding: 1rem 0;
            overflow-y: auto;
        }

        .nav-section {
            margin-bottom: 1.5rem;
        }

        .nav-section-title {
            padding: 0.5rem 1.5rem;
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-muted);
            font-weight: 600;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem 1.5rem;
            color: var(--text-secondary);
            cursor: pointer;
            transition: var(--transition);
            border-left: 3px solid transparent;
        }

        .nav-item:hover {
            background: var(--light-bg);
            color: var(--primary-dark);
        }

        .nav-item.active {
            background: var(--light-bg);
            color: var(--primary-dark);
            border-left-color: var(--accent-gold);
            font-weight: 500;
        }

        .nav-icon {
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
        }

        .sidebar-footer {
            padding: 1rem 1.5rem;
            border-top: 1px solid var(--subtle-border);
        }

        .dark-mode-toggle {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.5rem;
            cursor: pointer;
            color: var(--text-secondary);
            font-size: 0.875rem;
        }

        .dark-mode-toggle:hover {
            color: var(--primary-dark);
        }

        /* Main Content */
        .main-content {
            flex: 1;
            margin-left: 260px;
            min-height: 100vh;
        }

        .page-header {
            background: var(--card-bg);
            border-bottom: 1px solid var(--subtle-border);
            padding: 1.5rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 50;
        }

        .page-title {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .page-title h1 {
            font-size: 1.5rem;
        }

        .page-subtitle {
            font-size: 0.875rem;
            color: var(--text-muted);
        }

        .header-actions {
            display: flex;
            gap: 0.75rem;
            align-items: center;
        }

        .page-content {
            padding: 2rem;
        }

        /* Buttons */
        .btn {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.625rem 1.25rem;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition);
            border: none;
            font-family: inherit;
        }

        .btn-primary {
            background: var(--primary-dark);
            color: var(--card-bg);
        }

        .btn-primary:hover {
            opacity: 0.9;
        }

        .btn-secondary {
            background: transparent;
            color: var(--primary-dark);
            border: 1px solid var(--subtle-border);
        }

        .btn-secondary:hover {
            background: var(--light-bg);
        }

        .btn-gold {
            background: var(--accent-gold);
            color: var(--primary-dark);
        }

        .btn-gold:hover {
            opacity: 0.9;
        }

        .btn-success {
            background: var(--success-green);
            color: white;
        }

        .btn-danger {
            background: var(--danger-red);
            color: white;
        }

        .btn-sm {
            padding: 0.375rem 0.75rem;
            font-size: 0.8rem;
        }

        .btn-icon {
            padding: 0.5rem;
            min-width: 36px;
            justify-content: center;
        }

        /* Cards */
        .card {
            background: var(--card-bg);
            border: 1px solid var(--subtle-border);
            padding: 1.5rem;
            transition: var(--transition);
        }

        .card:hover {
            box-shadow: var(--shadow-md);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .card-title {
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-muted);
            font-weight: 600;
        }

        /* Stats */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: var(--card-bg);
            border: 1px solid var(--subtle-border);
            padding: 1.25rem;
        }

        .stat-label {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-muted);
            margin-bottom: 0.5rem;
        }

        .stat-value {
            font-size: 1.75rem;
            font-weight: 600;
            font-family: var(--font-mono);
        }

        .stat-trend {
            font-size: 0.8rem;
            margin-top: 0.25rem;
        }

        .stat-trend.up { color: var(--success-green); }
        .stat-trend.down { color: var(--danger-red); }

        /* Status Badges */
        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.375rem;
            padding: 0.25rem 0.75rem;
            font-size: 0.75rem;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .status-green {
            background: rgba(34, 197, 94, 0.1);
            color: var(--success-green);
        }

        .status-yellow {
            background: rgba(245, 158, 11, 0.1);
            color: var(--warning-amber);
        }

        .status-red {
            background: rgba(239, 68, 68, 0.1);
            color: var(--danger-red);
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }

        .status-dot.green { background: var(--success-green); }
        .status-dot.yellow { background: var(--warning-amber); }
        .status-dot.red { background: var(--danger-red); }

        /* Tables */
        .table-container {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 0.875rem 1rem;
            text-align: left;
            border-bottom: 1px solid var(--subtle-border);
        }

        th {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-muted);
            font-weight: 600;
            background: var(--light-bg);
        }

        tr:hover {
            background: var(--light-bg);
        }

        /* Forms */
        .form-group {
            margin-bottom: 1rem;
        }

        .form-label {
            display: block;
            font-size: 0.875rem;
            font-weight: 500;
            margin-bottom: 0.5rem;
        }

        .form-input, .form-select, .form-textarea {
            width: 100%;
            padding: 0.625rem 0.875rem;
            font-size: 0.875rem;
            border: 1px solid var(--subtle-border);
            background: var(--card-bg);
            color: var(--primary-dark);
            font-family: inherit;
            transition: var(--transition);
        }

        .form-input:focus, .form-select:focus, .form-textarea:focus {
            outline: none;
            border-color: var(--accent-gold);
        }

        .form-textarea {
            min-height: 100px;
            resize: vertical;
        }

        /* Progress Bar */
        .progress-bar {
            height: 8px;
            background: var(--subtle-border);
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: var(--accent-gold);
            transition: width 0.3s ease;
        }

        .progress-fill.green { background: var(--success-green); }
        .progress-fill.yellow { background: var(--warning-amber); }
        .progress-fill.red { background: var(--danger-red); }

        /* Rock Cards */
        .rocks-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 1.5rem;
        }

        .rock-card {
            background: var(--card-bg);
            border: 1px solid var(--subtle-border);
            padding: 1.5rem;
        }

        .rock-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
        }

        .rock-title {
            font-size: 1.1rem;
            font-weight: 500;
            margin-bottom: 0.25rem;
        }

        .rock-owner {
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        .rock-progress {
            margin: 1rem 0;
        }

        .rock-progress-label {
            display: flex;
            justify-content: space-between;
            font-size: 0.8rem;
            margin-bottom: 0.5rem;
        }

        .rock-milestones {
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid var(--subtle-border);
        }

        .milestone-item {
            display: flex;
            align-items: flex-start;
            gap: 0.75rem;
            padding: 0.5rem 0;
            font-size: 0.875rem;
        }

        .milestone-checkbox {
            width: 18px;
            height: 18px;
            border: 2px solid var(--subtle-border);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            margin-top: 2px;
        }

        .milestone-checkbox.checked {
            background: var(--success-green);
            border-color: var(--success-green);
            color: white;
        }

        .milestone-text.completed {
            text-decoration: line-through;
            color: var(--text-muted);
        }

        .rock-due {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-top: 1rem;
        }

        /* Issues List */
        .issues-list {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .issue-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            background: var(--card-bg);
            border: 1px solid var(--subtle-border);
            cursor: grab;
            transition: var(--transition);
        }

        .issue-item:hover {
            box-shadow: var(--shadow-sm);
        }

        .issue-item.dragging {
            opacity: 0.5;
        }

        .issue-priority {
            font-family: var(--font-mono);
            font-size: 0.875rem;
            color: var(--text-muted);
            min-width: 24px;
        }

        .issue-content {
            flex: 1;
        }

        .issue-title {
            font-weight: 500;
            margin-bottom: 0.25rem;
        }

        .issue-meta {
            display: flex;
            gap: 1rem;
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        .issue-source {
            padding: 0.125rem 0.5rem;
            background: var(--light-bg);
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .issue-actions {
            display: flex;
            gap: 0.5rem;
        }

        /* To-Do List */
        .todo-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            background: var(--card-bg);
            border: 1px solid var(--subtle-border);
            margin-bottom: 0.5rem;
        }

        .todo-checkbox {
            width: 22px;
            height: 22px;
            border: 2px solid var(--subtle-border);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .todo-checkbox.checked {
            background: var(--success-green);
            border-color: var(--success-green);
            color: white;
        }

        .todo-content {
            flex: 1;
        }

        .todo-title {
            font-weight: 500;
        }

        .todo-title.completed {
            text-decoration: line-through;
            color: var(--text-muted);
        }

        .todo-meta {
            display: flex;
            gap: 1rem;
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-top: 0.25rem;
        }

        .carried-badge {
            background: var(--danger-red);
            color: white;
            padding: 0.125rem 0.5rem;
            font-size: 0.7rem;
        }

        /* Meeting Mode */
        .meeting-mode {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--light-bg);
            z-index: 1000;
            display: none;
            flex-direction: column;
        }

        .meeting-mode.active {
            display: flex;
        }

        .meeting-header {
            background: var(--forest-green);
            color: white;
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .meeting-timer {
            font-family: var(--font-mono);
            font-size: 2.5rem;
            font-weight: 600;
            color: var(--accent-gold);
        }

        .meeting-progress {
            display: flex;
            gap: 0.25rem;
            margin: 0 2rem;
            flex: 1;
            max-width: 600px;
        }

        .meeting-progress-segment {
            flex: 1;
            height: 8px;
            background: rgba(255,255,255,0.2);
        }

        .meeting-progress-segment.active {
            background: var(--accent-gold);
        }

        .meeting-progress-segment.completed {
            background: var(--success-green);
        }

        .meeting-body {
            flex: 1;
            overflow-y: auto;
            padding: 2rem;
        }

        .meeting-section-title {
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }

        .meeting-section-time {
            font-size: 1rem;
            color: var(--text-muted);
            margin-bottom: 2rem;
        }

        .meeting-nav {
            display: flex;
            gap: 1rem;
            padding: 1rem 2rem;
            background: var(--card-bg);
            border-top: 1px solid var(--subtle-border);
        }

        /* Vision Page */
        .vision-section {
            background: var(--card-bg);
            border: 1px solid var(--subtle-border);
            padding: 2rem;
            margin-bottom: 2rem;
        }

        .vision-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .vision-icon {
            width: 48px;
            height: 48px;
            background: var(--forest-green);
            color: var(--accent-gold);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }

        .vision-title {
            font-size: 1.25rem;
        }

        .vision-subtitle {
            font-size: 0.875rem;
            color: var(--text-muted);
        }

        .vision-content {
            font-size: 1.1rem;
            line-height: 1.8;
        }

        .vision-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-top: 1.5rem;
        }

        .vision-stat {
            text-align: center;
            padding: 1rem;
            background: var(--light-bg);
        }

        .vision-stat-value {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--accent-gold);
            font-family: var(--font-mono);
        }

        .vision-stat-label {
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-top: 0.25rem;
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: var(--card-bg);
            width: 100%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--subtle-border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-body {
            padding: 1.5rem;
        }

        .modal-footer {
            padding: 1rem 1.5rem;
            border-top: 1px solid var(--subtle-border);
            display: flex;
            justify-content: flex-end;
            gap: 0.75rem;
        }

        /* Page Views */
        .page-view {
            display: none;
        }

        .page-view.active {
            display: block;
        }

        /* Quick Focus Section */
        .focus-section {
            background: linear-gradient(135deg, var(--forest-green) 0%, #2a4a3e 100%);
            color: white;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }

        .focus-title {
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--accent-gold);
            margin-bottom: 1rem;
        }

        .focus-items {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .focus-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem;
            background: rgba(255,255,255,0.1);
        }

        .focus-number {
            width: 24px;
            height: 24px;
            background: var(--accent-gold);
            color: var(--forest-green);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 0.8rem;
        }

        /* Sections Grid */
        .sections-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1.5rem;
        }

        .section-full {
            grid-column: 1 / -1;
        }

        /* Filter Tabs */
        .filter-tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
        }

        .filter-tab {
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
            cursor: pointer;
            border: 1px solid var(--subtle-border);
            background: var(--card-bg);
            transition: var(--transition);
        }

        .filter-tab.active {
            background: var(--primary-dark);
            color: var(--card-bg);
            border-color: var(--primary-dark);
        }

        /* Save Indicator */
        .save-indicator {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            padding: 0.75rem 1.25rem;
            background: var(--forest-green);
            color: white;
            font-size: 0.875rem;
            display: none;
            align-items: center;
            gap: 0.5rem;
            z-index: 999;
        }

        .save-indicator.active {
            display: flex;
        }

        /* Toast Notifications */
        .toast {
            position: fixed;
            bottom: 2rem;
            left: 50%;
            transform: translateX(-50%);
            padding: 1rem 1.5rem;
            background: var(--primary-dark);
            color: var(--card-bg);
            display: none;
            z-index: 1001;
        }

        .toast.active {
            display: block;
        }

        /* Keyboard Shortcut Hints */
        .kbd {
            display: inline-block;
            padding: 0.125rem 0.375rem;
            font-family: var(--font-mono);
            font-size: 0.75rem;
            background: var(--light-bg);
            border: 1px solid var(--subtle-border);
            margin-left: 0.5rem;
        }

        /* Print Styles */
        @media print {
            .sidebar, .page-header, .btn, .meeting-mode {
                display: none !important;
            }
            .main-content {
                margin-left: 0;
            }
            .card {
                break-inside: avoid;
            }
        }

        /* Editable Cells */
        .editable {
            cursor: pointer;
            padding: 0.25rem 0.5rem;
            margin: -0.25rem -0.5rem;
            border: 1px solid transparent;
            transition: var(--transition);
        }

        .editable:hover {
            background: var(--light-bg);
            border-color: var(--subtle-border);
        }

        .editable:focus {
            outline: none;
            border-color: var(--accent-gold);
            background: var(--card-bg);
        }

        /* Sparkline */
        .sparkline {
            display: inline-block;
            width: 60px;
            height: 20px;
            vertical-align: middle;
        }

        .sparkline svg {
            width: 100%;
            height: 100%;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 3rem;
            color: var(--text-muted);
        }

        .empty-state-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
        }

        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .animate-in {
            animation: fadeIn 0.3s ease;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .pulse {
            animation: pulse 2s infinite;
        }

        /* Milestone Edit Item */
        .milestone-edit-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem;
            background: var(--light-bg);
            margin-bottom: 0.5rem;
        }

        .milestone-edit-item input {
            flex: 1;
        }

        /* Meeting History Styles */
        .meeting-history-card {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            background: var(--card-bg);
            border: 1px solid var(--subtle-border);
            margin-bottom: 0.5rem;
        }

        .meeting-rating {
            width: 48px;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
            font-weight: 600;
            font-family: var(--font-mono);
        }

        .meeting-rating.high { background: rgba(34, 197, 94, 0.2); color: var(--success-green); }
        .meeting-rating.medium { background: rgba(245, 158, 11, 0.2); color: var(--warning-amber); }
        .meeting-rating.low { background: rgba(239, 68, 68, 0.2); color: var(--danger-red); }

        .history-stats {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .history-stat {
            background: var(--card-bg);
            border: 1px solid var(--subtle-border);
            padding: 1.5rem;
            text-align: center;
        }

        .history-stat-value {
            font-size: 2rem;
            font-weight: 600;
            font-family: var(--font-mono);
        }

        .history-stat-label {
            font-size: 0.8rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        /* Rating Chart */
        .rating-chart {
            height: 120px;
            display: flex;
            align-items: flex-end;
            gap: 4px;
            padding: 1rem 0;
        }

        .rating-bar {
            flex: 1;
            background: var(--accent-gold);
            min-height: 8px;
            transition: var(--transition);
            position: relative;
        }

        .rating-bar:hover {
            opacity: 0.8;
        }

        .rating-bar::after {
            content: attr(data-rating);
            position: absolute;
            bottom: -20px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 0.7rem;
            color: var(--text-muted);
        }

        /* Meeting Card Actions */
        .meeting-actions {
            display: flex;
            gap: 0.5rem;
            opacity: 0;
            transition: var(--transition);
        }

        .meeting-history-card:hover .meeting-actions {
            opacity: 1;
        }

        .meeting-actions .btn-icon {
            width: 32px;
            height: 32px;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.875rem;
        }

        /* Meeting Notes Display */
        .meeting-notes {
            font-size: 0.8rem;
            color: var(--text-muted);
            font-style: italic;
            margin-top: 0.25rem;
            max-width: 300px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        /* Rock Notes Display */
        .rock-notes {
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-top: 0.5rem;
            padding: 0.5rem;
            background: var(--light-bg);
            font-style: italic;
        }

        /* Vision Edit Mode */
        .vision-editable {
            border: 1px dashed var(--subtle-border);
            padding: 0.5rem;
            background: var(--card-bg);
            min-height: 2rem;
        }

        .vision-editable:focus {
            outline: none;
            border-color: var(--accent-gold);
        }

        /* Recent Meetings Widget */
        .recent-meeting-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 0;
            border-bottom: 1px solid var(--subtle-border);
        }

        .recent-meeting-item:last-child {
            border-bottom: none;
        }

        /* Edit Button on Cards */
        .card-edit-btn {
            opacity: 0;
            transition: var(--transition);
        }

        .rock-card:hover .card-edit-btn,
        tr:hover .card-edit-btn {
            opacity: 1;
        }

        /* Paused Meeting Banner */
        .paused-meeting-banner {
            display: none;
            align-items: center;
            justify-content: space-between;
            padding: 0.75rem 1rem;
            background: linear-gradient(90deg, var(--accent-gold) 0%, #c9a855 100%);
            color: var(--bg-primary);
            border-radius: 8px;
            margin-bottom: 1.5rem;
            font-weight: 500;
            box-shadow: 0 2px 8px rgba(223, 189, 105, 0.3);
        }

        .paused-meeting-banner.visible {
            display: flex;
        }

        .paused-meeting-info {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .paused-meeting-info .pause-icon {
            font-size: 1.25rem;
        }

        .paused-meeting-actions {
            display: flex;
            gap: 0.5rem;
        }

        .paused-meeting-actions .btn {
            padding: 0.4rem 0.75rem;
            font-size: 0.875rem;
        }

        .paused-meeting-actions .btn-resume {
            background: var(--bg-primary);
            color: var(--accent-gold);
        }

        .paused-meeting-actions .btn-discard {
            background: transparent;
            color: var(--bg-primary);
            border: 1px solid var(--bg-primary);
        }

        /* Nav item paused indicator */
        .nav-item.has-paused {
            position: relative;
            background: rgba(223, 189, 105, 0.15);
        }

        .nav-item.has-paused::after {
            content: '';
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            width: 8px;
            height: 8px;
            background: var(--accent-gold);
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.4; }
        }

        /* =====================================================
           AUTH / LOGIN STYLES
           ===================================================== */
        .auth-container {
            position: fixed;
            inset: 0;
            background: var(--light-bg);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
        }

        .auth-card {
            background: var(--card-bg);
            border: 1px solid var(--subtle-border);
            padding: 2.5rem;
            width: 100%;
            max-width: 400px;
            box-shadow: var(--shadow-lg);
        }

        .auth-logo {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.75rem;
            margin-bottom: 2rem;
        }

        .auth-logo .logo-icon {
            width: 48px;
            height: 48px;
            font-size: 1.5rem;
        }

        .auth-title {
            font-size: 1.5rem;
            font-weight: 600;
            text-align: center;
            margin-bottom: 0.5rem;
        }

        .auth-subtitle {
            font-size: 0.875rem;
            color: var(--text-muted);
            text-align: center;
            margin-bottom: 2rem;
        }

        .auth-form {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .auth-input-group {
            display: flex;
            flex-direction: column;
            gap: 0.375rem;
        }

        .auth-input-group label {
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--text-secondary);
        }

        .auth-input {
            padding: 0.75rem 1rem;
            font-size: 1rem;
            border: 1px solid var(--subtle-border);
            background: var(--card-bg);
            color: var(--primary-dark);
            transition: var(--transition);
        }

        .auth-input:focus {
            outline: none;
            border-color: var(--accent-gold);
            box-shadow: 0 0 0 2px rgba(223, 189, 105, 0.2);
        }

        .auth-btn {
            padding: 0.875rem 1.5rem;
            font-size: 1rem;
            font-weight: 500;
            background: var(--forest-green);
            color: white;
            border: none;
            cursor: pointer;
            transition: var(--transition);
            margin-top: 0.5rem;
        }

        .auth-btn:hover {
            background: #2a4a3d;
        }

        .auth-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .auth-divider {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin: 1.5rem 0;
            color: var(--text-muted);
            font-size: 0.75rem;
            text-transform: uppercase;
        }

        .auth-divider::before,
        .auth-divider::after {
            content: '';
            flex: 1;
            height: 1px;
            background: var(--subtle-border);
        }

        .auth-switch {
            text-align: center;
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        .auth-switch a {
            color: var(--accent-gold);
            cursor: pointer;
            font-weight: 500;
        }

        .auth-switch a:hover {
            text-decoration: underline;
        }

        .auth-error {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid var(--danger-red);
            color: var(--danger-red);
            padding: 0.75rem 1rem;
            font-size: 0.875rem;
            margin-bottom: 1rem;
            display: none;
        }

        .auth-error.visible {
            display: block;
        }

        .auth-success {
            background: rgba(34, 197, 94, 0.1);
            border: 1px solid var(--success-green);
            color: var(--success-green);
            padding: 0.75rem 1rem;
            font-size: 0.875rem;
            margin-bottom: 1rem;
            display: none;
        }

        .auth-success.visible {
            display: block;
        }

        /* User header section */
        .user-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem 1rem;
            background: var(--light-bg);
            border: 1px solid var(--subtle-border);
            margin-left: auto;
        }

        .user-avatar {
            width: 32px;
            height: 32px;
            background: var(--forest-green);
            color: var(--accent-gold);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 0.875rem;
            border-radius: 50%;
        }

        .user-info {
            display: flex;
            flex-direction: column;
        }

        .user-name {
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--primary-dark);
        }

        .user-email {
            font-size: 0.7rem;
            color: var(--text-muted);
        }

        .logout-btn {
            padding: 0.375rem 0.75rem;
            font-size: 0.75rem;
            background: transparent;
            border: 1px solid var(--subtle-border);
            color: var(--text-secondary);
            cursor: pointer;
            transition: var(--transition);
        }

        .logout-btn:hover {
            border-color: var(--danger-red);
            color: var(--danger-red);
        }

        /* Loading overlay */
        .loading-overlay {
            position: fixed;
            inset: 0;
            background: var(--light-bg);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 1rem;
            z-index: 10001;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--subtle-border);
            border-top-color: var(--accent-gold);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-text {
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        /* Offline indicator */
        .offline-indicator {
            position: fixed;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            background: var(--warning-amber);
            color: white;
            padding: 0.5rem 1rem;
            font-size: 0.75rem;
            font-weight: 500;
            z-index: 9999;
            display: none;
        }

        .offline-indicator.visible {
            display: block;
        }

        /* Sync indicator */
        .sync-indicator {
            display: flex;
            align-items: center;
            gap: 0.375rem;
            font-size: 0.75rem;
            color: var(--text-muted);
            padding: 0.25rem 0.5rem;
        }

        .sync-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: var(--success-green);
        }

        .sync-dot.syncing {
            background: var(--warning-amber);
            animation: pulse 1s infinite;
        }
    </style>
</head>
<body>
    <!-- Loading Overlay (shown during initial auth check) -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="loading-spinner"></div>
        <div class="loading-text">Loading...</div>
    </div>

    <!-- Offline Indicator -->
    <div id="offlineIndicator" class="offline-indicator">
        You're offline. Changes will sync when you reconnect.
    </div>

    <!-- Auth Container (Login/Signup) -->
    <div id="authContainer" class="auth-container" style="display: none;">
        <div class="auth-card">
            <div class="auth-logo">
                <div class="logo-icon">V</div>
                <div>
                    <div class="logo-text">Valhalla</div>
                    <div class="logo-subtitle">EOS Dashboard</div>
                </div>
            </div>

            <!-- Login Form -->
            <div id="loginForm">
                <h2 class="auth-title">Welcome back</h2>
                <p class="auth-subtitle">Sign in to your EOS dashboard</p>

                <div id="loginError" class="auth-error"></div>

                <form class="auth-form" onsubmit="handleLogin(event)">
                    <div class="auth-input-group">
                        <label for="loginEmail">Email</label>
                        <input type="email" id="loginEmail" class="auth-input" placeholder="you@company.com" required>
                    </div>
                    <div class="auth-input-group">
                        <label for="loginPassword">Password</label>
                        <input type="password" id="loginPassword" class="auth-input" placeholder="Enter your password" required>
                    </div>
                    <button type="submit" id="loginBtn" class="auth-btn">Sign In</button>
                </form>

                <div class="auth-divider">or</div>

                <p class="auth-switch">
                    Don't have an account? <a onclick="showSignupForm()">Sign up</a>
                </p>
            </div>

            <!-- Signup Form -->
            <div id="signupForm" style="display: none;">
                <h2 class="auth-title">Create account</h2>
                <p class="auth-subtitle">Get started with your EOS dashboard</p>

                <div id="signupError" class="auth-error"></div>
                <div id="signupSuccess" class="auth-success"></div>

                <form class="auth-form" onsubmit="handleSignup(event)">
                    <div class="auth-input-group">
                        <label for="signupName">Full Name</label>
                        <input type="text" id="signupName" class="auth-input" placeholder="Joel or Lee" required>
                    </div>
                    <div class="auth-input-group">
                        <label for="signupEmail">Email</label>
                        <input type="email" id="signupEmail" class="auth-input" placeholder="you@company.com" required>
                    </div>
                    <div class="auth-input-group">
                        <label for="signupPassword">Password</label>
                        <input type="password" id="signupPassword" class="auth-input" placeholder="Create a password (min 6 chars)" required minlength="6">
                    </div>
                    <div class="auth-input-group">
                        <label for="signupCompany">Company Name</label>
                        <input type="text" id="signupCompany" class="auth-input" placeholder="Valhalla Holdings" value="Valhalla Holdings">
                    </div>
                    <button type="submit" id="signupBtn" class="auth-btn">Create Account</button>
                </form>

                <div class="auth-divider">or</div>

                <p class="auth-switch">
                    Already have an account? <a onclick="showLoginForm()">Sign in</a>
                </p>
            </div>
        </div>
    </div>

    <div class="app-container" id="appContainer" style="display: none;">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <div class="logo">
                    <div class="logo-icon">V</div>
                    <div>
                        <div class="logo-text">Valhalla</div>
                        <div class="logo-subtitle">EOS Dashboard</div>
                    </div>
                </div>
            </div>

            <nav class="sidebar-nav">
                <div class="nav-section">
                    <div class="nav-section-title">Overview</div>
                    <div class="nav-item active" data-page="dashboard">
                        <span class="nav-icon">&#9673;</span>
                        <span>Dashboard</span>
                    </div>
                </div>

                <div class="nav-section">
                    <div class="nav-section-title">Traction</div>
                    <div class="nav-item" data-page="scorecard">
                        <span class="nav-icon">&#9638;</span>
                        <span>Scorecard</span>
                    </div>
                    <div class="nav-item" data-page="rocks">
                        <span class="nav-icon">&#9670;</span>
                        <span>Rocks</span>
                    </div>
                    <div class="nav-item" data-page="issues">
                        <span class="nav-icon">&#9888;</span>
                        <span>Issues</span>
                    </div>
                    <div class="nav-item" data-page="todos">
                        <span class="nav-icon">&#10003;</span>
                        <span>To-Dos</span>
                    </div>
                </div>

                <div class="nav-section">
                    <div class="nav-section-title">Vision</div>
                    <div class="nav-item" data-page="vision">
                        <span class="nav-icon">&#9733;</span>
                        <span>Vision & Goals</span>
                    </div>
                </div>

                <div class="nav-section">
                    <div class="nav-section-title">Meeting</div>
                    <div class="nav-item" data-page="meeting" id="startMeetingNav">
                        <span class="nav-icon">&#9201;</span>
                        <span>Level 10 Meeting</span>
                    </div>
                    <div class="nav-item" data-page="history">
                        <span class="nav-icon">&#128200;</span>
                        <span>Meeting History</span>
                    </div>
                </div>
            </nav>

            <div class="sidebar-footer">
                <!-- User Info Section -->
                <div id="userSection" class="user-header" style="margin-bottom: 0.75rem; border-radius: 4px;">
                    <div class="user-avatar" id="userAvatar">?</div>
                    <div class="user-info" style="flex: 1; min-width: 0;">
                        <div class="user-name" id="userName">Loading...</div>
                        <div class="user-email" id="userEmail" style="overflow: hidden; text-overflow: ellipsis; white-space: nowrap;"></div>
                    </div>
                    <button class="logout-btn" onclick="handleLogout()" title="Sign out">Logout</button>
                </div>

                <!-- Sync Status -->
                <div class="sync-indicator" id="syncIndicator" style="margin-bottom: 0.5rem;">
                    <div class="sync-dot" id="syncDot"></div>
                    <span id="syncText">Synced</span>
                </div>

                <div class="dark-mode-toggle" id="darkModeToggle">
                    <span id="darkModeIcon">&#9790;</span>
                    <span id="darkModeText">Dark Mode</span>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Dashboard Page -->
            <div class="page-view active" id="page-dashboard">
                <div class="page-header">
                    <div class="page-title">
                        <h1>Dashboard</h1>
                        <span class="page-subtitle">Q1 2026 Overview</span>
                    </div>
                    <div class="header-actions">
                        <button class="btn btn-gold" onclick="startMeeting()">
                            &#9201; Start Level 10
                        </button>
                    </div>
                </div>

                <!-- Paused Meeting Banner -->
                <div class="paused-meeting-banner" id="pausedMeetingBanner">
                    <div class="paused-meeting-info">
                        <span class="pause-icon">⏸️</span>
                        <span id="pausedMeetingText">Meeting in progress</span>
                    </div>
                    <div class="paused-meeting-actions">
                        <button class="btn btn-resume" onclick="resumePausedMeeting()">Resume</button>
                        <button class="btn btn-discard" onclick="discardPausedMeeting()">Discard</button>
                    </div>
                </div>

                <div class="page-content">
                    <!-- Quick Stats -->
                    <div class="stats-grid" id="dashboardStats">
                        <!-- Populated by JS -->
                    </div>

                    <!-- Focus Section -->
                    <div class="focus-section">
                        <div class="focus-title">This Week's Focus</div>
                        <div class="focus-items" id="focusItems">
                            <!-- Populated by JS -->
                        </div>
                    </div>

                    <div class="sections-grid">
                        <!-- Scorecard Snapshot -->
                        <div class="card">
                            <div class="card-header">
                                <span class="card-title">Scorecard Snapshot</span>
                                <button class="btn btn-secondary btn-sm" onclick="navigateTo('scorecard')">View All</button>
                            </div>
                            <div id="scorecardSnapshot">
                                <!-- Populated by JS -->
                            </div>
                        </div>

                        <!-- Rocks Progress -->
                        <div class="card">
                            <div class="card-header">
                                <span class="card-title">Q1 Rocks Progress</span>
                                <button class="btn btn-secondary btn-sm" onclick="navigateTo('rocks')">View All</button>
                            </div>
                            <div id="rocksSnapshot">
                                <!-- Populated by JS -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Scorecard Page -->
            <div class="page-view" id="page-scorecard">
                <div class="page-header">
                    <div class="page-title">
                        <h1>Scorecard</h1>
                        <span class="page-subtitle">Weekly Metrics - Track what matters</span>
                    </div>
                    <div class="header-actions">
                        <button class="btn btn-secondary" onclick="addWeeklyData()">+ Add Week</button>
                    </div>
                </div>

                <div class="page-content">
                    <div class="card section-full">
                        <div class="table-container">
                            <table id="scorecardTable">
                                <thead>
                                    <tr>
                                        <th>Metric</th>
                                        <th>Owner</th>
                                        <th>Goal</th>
                                        <th>Current</th>
                                        <th>Status</th>
                                        <th>Trend</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="scorecardBody">
                                    <!-- Populated by JS -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Rocks Page -->
            <div class="page-view" id="page-rocks">
                <div class="page-header">
                    <div class="page-title">
                        <h1>Rocks</h1>
                        <span class="page-subtitle">Q1 2026 Priorities - Due March 31</span>
                    </div>
                    <div class="header-actions">
                        <button class="btn btn-primary" onclick="openRockModal()">+ Add Rock</button>
                    </div>
                </div>

                <div class="page-content">
                    <div class="filter-tabs">
                        <div class="filter-tab active" data-filter="all">All</div>
                        <div class="filter-tab" data-filter="Joel">Joel</div>
                        <div class="filter-tab" data-filter="Lee">Lee</div>
                    </div>

                    <div class="rocks-grid" id="rocksGrid">
                        <!-- Populated by JS -->
                    </div>
                </div>
            </div>

            <!-- Issues Page -->
            <div class="page-view" id="page-issues">
                <div class="page-header">
                    <div class="page-title">
                        <h1>Issues List</h1>
                        <span class="page-subtitle">Identify, Discuss, Solve</span>
                    </div>
                    <div class="header-actions">
                        <button class="btn btn-primary" onclick="openIssueModal()">+ Add Issue</button>
                    </div>
                </div>

                <div class="page-content">
                    <div class="filter-tabs">
                        <div class="filter-tab active" data-filter="open">Open</div>
                        <div class="filter-tab" data-filter="in-discussion">In Discussion</div>
                        <div class="filter-tab" data-filter="resolved">Resolved</div>
                        <div class="filter-tab" data-filter="all">All</div>
                    </div>

                    <div class="issues-list" id="issuesList">
                        <!-- Populated by JS -->
                    </div>
                </div>
            </div>

            <!-- To-Dos Page -->
            <div class="page-view" id="page-todos">
                <div class="page-header">
                    <div class="page-title">
                        <h1>To-Do List</h1>
                        <span class="page-subtitle">Weekly Commitments</span>
                    </div>
                    <div class="header-actions">
                        <button class="btn btn-primary" onclick="openTodoModal()">+ Add To-Do</button>
                    </div>
                </div>

                <div class="page-content">
                    <div class="filter-tabs">
                        <div class="filter-tab active" data-filter="all">All</div>
                        <div class="filter-tab" data-filter="Joel">Joel</div>
                        <div class="filter-tab" data-filter="Lee">Lee</div>
                        <div class="filter-tab" data-filter="pending">Pending</div>
                        <div class="filter-tab" data-filter="complete">Complete</div>
                    </div>

                    <div id="todosList">
                        <!-- Populated by JS -->
                    </div>
                </div>
            </div>

            <!-- Vision Page -->
            <div class="page-view" id="page-vision">
                <div class="page-header">
                    <div class="page-title">
                        <h1>Vision & Goals</h1>
                        <span class="page-subtitle">Where we're going</span>
                    </div>
                    <div class="header-actions">
                        <button class="btn btn-secondary" id="visionEditToggle" onclick="toggleVisionEditMode()">
                            &#9998; Edit
                        </button>
                    </div>
                </div>

                <div class="page-content" id="visionContent">
                    <!-- Populated by JS -->
                </div>
            </div>

            <!-- Meeting History Page -->
            <div class="page-view" id="page-history">
                <div class="page-header">
                    <div class="page-title">
                        <h1>Meeting History</h1>
                        <span class="page-subtitle">Track your Level 10 progress</span>
                    </div>
                </div>

                <div class="page-content" id="historyContent">
                    <!-- Populated by JS -->
                </div>
            </div>
        </main>
    </div>

    <!-- Meeting Mode Overlay -->
    <div class="meeting-mode" id="meetingMode">
        <div class="meeting-header">
            <div>
                <div style="font-size: 0.8rem; opacity: 0.8;">Level 10 Meeting</div>
                <div id="meetingSectionName" style="font-size: 1.25rem; font-weight: 500;">Segue</div>
            </div>
            <div class="meeting-progress" id="meetingProgress">
                <!-- Populated by JS -->
            </div>
            <div class="meeting-timer" id="meetingTimer">05:00</div>
            <div style="display: flex; gap: 0.5rem; margin-left: 1rem;">
                <button class="btn btn-gold" onclick="pauseMeeting()" title="Save progress and exit">Pause</button>
                <button class="btn" onclick="exitMeeting()" title="Exit meeting" style="background: rgba(255,255,255,0.2); color: white; border: 1px solid rgba(255,255,255,0.3);">Exit</button>
            </div>
        </div>

        <div class="meeting-body" id="meetingBody">
            <!-- Populated by JS based on section -->
        </div>

        <div class="meeting-nav">
            <button class="btn btn-secondary" id="prevSection" onclick="prevMeetingSection()">&#8592; Previous</button>
            <div style="flex:1;"></div>
            <button class="btn btn-gold" id="nextSection" onclick="nextMeetingSection()">Next &#8594;</button>
        </div>
    </div>

    <!-- Issue Modal -->
    <div class="modal-overlay" id="issueModal">
        <div class="modal">
            <div class="modal-header">
                <h3 id="issueModalTitle">Add Issue</h3>
                <button class="btn btn-icon btn-secondary" onclick="closeIssueModal()">&#10005;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Issue Title</label>
                    <input type="text" class="form-input" id="issueTitle" placeholder="What's the issue?">
                </div>
                <div class="form-group">
                    <label class="form-label">Source</label>
                    <select class="form-select" id="issueSource">
                        <option value="scorecard">Scorecard</option>
                        <option value="rock">Rock</option>
                        <option value="customer">Customer</option>
                        <option value="other">Other</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Notes</label>
                    <textarea class="form-textarea" id="issueNotes" placeholder="Additional context..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeIssueModal()">Cancel</button>
                <button class="btn btn-primary" onclick="saveIssue()">Save Issue</button>
            </div>
        </div>
    </div>

    <!-- Todo Modal -->
    <div class="modal-overlay" id="todoModal">
        <div class="modal">
            <div class="modal-header">
                <h3 id="todoModalTitle">Add To-Do</h3>
                <button class="btn btn-icon btn-secondary" onclick="closeTodoModal()">&#10005;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">To-Do</label>
                    <input type="text" class="form-input" id="todoTitle" placeholder="What needs to be done?">
                </div>
                <div class="form-group">
                    <label class="form-label">Owner</label>
                    <select class="form-select" id="todoOwner">
                        <option value="Joel">Joel</option>
                        <option value="Lee">Lee</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Due Date</label>
                    <input type="date" class="form-input" id="todoDueDate">
                </div>
                <div class="form-group">
                    <label class="form-label">Notes</label>
                    <textarea class="form-textarea" id="todoNotes" placeholder="Additional details..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeTodoModal()">Cancel</button>
                <button class="btn btn-primary" onclick="saveTodo()">Save To-Do</button>
            </div>
        </div>
    </div>

    <!-- Rock Modal (Add New) -->
    <div class="modal-overlay" id="rockModal">
        <div class="modal">
            <div class="modal-header">
                <h3>Add Rock</h3>
                <button class="btn btn-icon btn-secondary" onclick="closeRockModal()">&#10005;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Rock Title</label>
                    <input type="text" class="form-input" id="rockTitle" placeholder="What's the priority?">
                </div>
                <div class="form-group">
                    <label class="form-label">Owner</label>
                    <select class="form-select" id="rockOwner">
                        <option value="Joel">Joel</option>
                        <option value="Lee">Lee</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Due Date</label>
                    <input type="date" class="form-input" id="rockDueDate" value="2026-03-31">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeRockModal()">Cancel</button>
                <button class="btn btn-primary" onclick="saveRock()">Save Rock</button>
            </div>
        </div>
    </div>

    <!-- Edit Rock Modal (Enhanced) -->
    <div class="modal-overlay" id="editRockModal">
        <div class="modal" style="max-width: 600px;">
            <div class="modal-header">
                <h3>Edit Rock</h3>
                <button class="btn btn-icon btn-secondary" onclick="closeEditRockModal()">&#10005;</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="editRockId">
                <div class="form-group">
                    <label class="form-label">Rock Title</label>
                    <input type="text" class="form-input" id="editRockTitle" placeholder="What's the priority?">
                </div>
                <div class="form-group">
                    <label class="form-label">Notes / Description</label>
                    <textarea class="form-textarea" id="editRockNotes" placeholder="Additional context about this rock..."></textarea>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div class="form-group">
                        <label class="form-label">Owner</label>
                        <select class="form-select" id="editRockOwner">
                            <option value="Joel">Joel</option>
                            <option value="Lee">Lee</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Due Date</label>
                        <input type="date" class="form-input" id="editRockDueDate">
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Status</label>
                    <select class="form-select" id="editRockStatus">
                        <option value="on-track">On Track</option>
                        <option value="at-risk">At Risk</option>
                        <option value="off-track">Off Track</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label" style="display: flex; justify-content: space-between; align-items: center;">
                        <span>Milestones</span>
                        <button class="btn btn-sm btn-secondary" onclick="addMilestoneToEditModal()">+ Add Milestone</button>
                    </label>
                    <div id="editRockMilestones" style="margin-top: 0.5rem;">
                        <!-- Populated by JS -->
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-danger" onclick="deleteRock()" style="margin-right: auto;">Delete Rock</button>
                <button class="btn btn-secondary" onclick="closeEditRockModal()">Cancel</button>
                <button class="btn btn-primary" onclick="saveRockEdits()">Save Changes</button>
            </div>
        </div>
    </div>

    <!-- Edit Metric Modal -->
    <div class="modal-overlay" id="editMetricModal">
        <div class="modal">
            <div class="modal-header">
                <h3>Edit Metric</h3>
                <button class="btn btn-icon btn-secondary" onclick="closeEditMetricModal()">&#10005;</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="editMetricId">
                <div class="form-group">
                    <label class="form-label">Metric Name</label>
                    <input type="text" class="form-input" id="editMetricName" placeholder="What are we measuring?">
                </div>
                <div class="form-group">
                    <label class="form-label">Goal / Target</label>
                    <input type="text" class="form-input" id="editMetricGoal" placeholder="e.g., 3%, £50, 10">
                </div>
                <div class="form-group">
                    <label class="form-label">Owner</label>
                    <select class="form-select" id="editMetricOwner">
                        <option value="Joel">Joel</option>
                        <option value="Lee">Lee</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Notes</label>
                    <textarea class="form-textarea" id="editMetricNotes" placeholder="Additional context..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeEditMetricModal()">Cancel</button>
                <button class="btn btn-primary" onclick="saveMetricEdits()">Save Changes</button>
            </div>
        </div>
    </div>

    <!-- Weekly Data Entry Modal -->
    <div class="modal-overlay" id="weeklyDataModal">
        <div class="modal" style="max-width: 600px;">
            <div class="modal-header">
                <h3>Log Weekly Data</h3>
                <button class="btn btn-icon btn-secondary" onclick="closeWeeklyDataModal()">&#10005;</button>
            </div>
            <div class="modal-body">
                <p style="color: var(--text-secondary); margin-bottom: 1rem;">Enter this week's values for all metrics:</p>
                <div id="weeklyDataFields">
                    <!-- Populated by JS -->
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeWeeklyDataModal()">Cancel</button>
                <button class="btn btn-primary" onclick="saveWeeklyData()">Save Week Data</button>
            </div>
        </div>
    </div>

    <!-- Rating Modal -->
    <div class="modal-overlay" id="ratingModal">
        <div class="modal">
            <div class="modal-header">
                <h3>Rate This Meeting</h3>
            </div>
            <div class="modal-body" style="text-align: center;">
                <p style="margin-bottom: 1.5rem; color: var(--text-secondary);">How would you rate today's Level 10?</p>
                <div id="ratingButtons" style="display: flex; gap: 0.5rem; justify-content: center; flex-wrap: wrap;">
                    <!-- Populated by JS -->
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Meeting Modal -->
    <div class="modal-overlay" id="editMeetingModal">
        <div class="modal" style="max-width: 500px;">
            <div class="modal-header">
                <h3>Edit Meeting</h3>
                <button class="btn btn-icon btn-secondary" onclick="closeEditMeetingModal()">&#10005;</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="editMeetingId">
                <div class="form-group">
                    <label class="form-label">Meeting Date</label>
                    <input type="datetime-local" class="form-input" id="editMeetingDate">
                </div>
                <div class="form-group">
                    <label class="form-label">Rating (1-10)</label>
                    <div id="editMeetingRatingButtons" style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                        <!-- Populated by JS -->
                    </div>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div class="form-group">
                        <label class="form-label">Issues Solved</label>
                        <input type="number" class="form-input" id="editMeetingIssuesSolved" min="0">
                    </div>
                    <div class="form-group">
                        <label class="form-label">To-Dos Created</label>
                        <input type="number" class="form-input" id="editMeetingTodosCreated" min="0">
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Notes</label>
                    <textarea class="form-textarea" id="editMeetingNotes" placeholder="Optional notes about this meeting..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-danger" onclick="deleteMeeting()" style="margin-right: auto;">Delete Meeting</button>
                <button class="btn btn-secondary" onclick="closeEditMeetingModal()">Cancel</button>
                <button class="btn btn-primary" onclick="saveMeetingEdits()">Save Changes</button>
            </div>
        </div>
    </div>

    <!-- Save Indicator -->
    <div class="save-indicator" id="saveIndicator">
        <span>&#10003;</span> Saved
    </div>

    <!-- Toast -->
    <div class="toast" id="toast"></div>

    <script>
        // =====================================================
        // SUPABASE CONFIGURATION
        // =====================================================
        // IMPORTANT: Replace these with your actual Supabase project credentials
        // Get these from: https://supabase.com/dashboard/project/YOUR_PROJECT/settings/api
        const SUPABASE_URL = 'https://aovoergyztmyegzedurx.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFvdm9lcmd5enRteWVnemVkdXJ4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjkwNzU1ODEsImV4cCI6MjA4NDY1MTU4MX0.lxPV2OurnKVOJsSRsiV3uJ581AzHP9jstpBcdvAzSao';

        // Initialize Supabase client
        let supabaseClient = null;
        let currentUser = null;
        let currentOrganization = null;
        let realtimeChannel = null;
        let isOnline = navigator.onLine;
        let pendingChanges = [];

        // Check if Supabase is configured
        function isSupabaseConfigured() {
            return SUPABASE_URL !== 'YOUR_SUPABASE_URL' &&
                   SUPABASE_ANON_KEY !== 'YOUR_SUPABASE_ANON_KEY' &&
                   SUPABASE_URL.includes('supabase.co');
        }

        // Initialize Supabase client if configured
        if (isSupabaseConfigured() && typeof window.supabase !== 'undefined') {
            supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
            console.log('Supabase client initialized');
        } else if (!isSupabaseConfigured()) {
            console.warn('Supabase not configured. Running in local-only mode.');
            console.warn('To enable multi-user sync, update SUPABASE_URL and SUPABASE_ANON_KEY');
        }

        // =====================================================
        // APPLICATION STATE
        // =====================================================
        let appData = null;
        let saveTimeout = null;
        let currentFilter = 'all';
        let editingIssueId = null;
        let editingTodoId = null;

        // Meeting State
        let meetingActive = false;
        let meetingSection = 0;
        let meetingTimer = null;
        let meetingSeconds = 0;
        let meetingStartTime = null;
        let meetingNotes = {};  // Store notes per section

        const MEETING_STORAGE_KEY = 'eos-meeting-progress';

        // =====================================================
        // AUTHENTICATION FUNCTIONS
        // =====================================================

        // Show/hide auth forms
        function showLoginForm() {
            document.getElementById('loginForm').style.display = 'block';
            document.getElementById('signupForm').style.display = 'none';
            document.getElementById('loginError').classList.remove('visible');
        }

        function showSignupForm() {
            document.getElementById('loginForm').style.display = 'none';
            document.getElementById('signupForm').style.display = 'block';
            document.getElementById('signupError').classList.remove('visible');
            document.getElementById('signupSuccess').classList.remove('visible');
        }

        // Handle login
        async function handleLogin(event) {
            event.preventDefault();

            if (!isSupabaseConfigured()) {
                showLocalOnlyMode();
                return;
            }

            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            const btn = document.getElementById('loginBtn');
            const errorDiv = document.getElementById('loginError');

            btn.disabled = true;
            btn.textContent = 'Signing in...';
            errorDiv.classList.remove('visible');

            try {
                const { data, error } = await supabaseClient.auth.signInWithPassword({
                    email,
                    password
                });

                if (error) throw error;

                // Auth state change listener will handle the rest
            } catch (error) {
                console.error('Login error:', error);
                errorDiv.textContent = error.message || 'Failed to sign in. Please check your credentials.';
                errorDiv.classList.add('visible');
                btn.disabled = false;
                btn.textContent = 'Sign In';
            }
        }

        // Handle signup
        async function handleSignup(event) {
            event.preventDefault();

            if (!isSupabaseConfigured()) {
                showLocalOnlyMode();
                return;
            }

            const name = document.getElementById('signupName').value;
            const email = document.getElementById('signupEmail').value;
            const password = document.getElementById('signupPassword').value;
            const company = document.getElementById('signupCompany').value || 'My Company';
            const btn = document.getElementById('signupBtn');
            const errorDiv = document.getElementById('signupError');
            const successDiv = document.getElementById('signupSuccess');

            btn.disabled = true;
            btn.textContent = 'Creating account...';
            errorDiv.classList.remove('visible');
            successDiv.classList.remove('visible');

            try {
                const { data, error } = await supabaseClient.auth.signUp({
                    email,
                    password,
                    options: {
                        data: {
                            name: name,
                            company: company
                        }
                    }
                });

                if (error) throw error;

                if (data.user && !data.user.confirmed_at) {
                    successDiv.textContent = 'Check your email to confirm your account, then sign in.';
                    successDiv.classList.add('visible');
                    btn.textContent = 'Account Created';
                } else {
                    // Auto-confirmed (in dev mode)
                    // Auth state change listener will handle the rest
                }
            } catch (error) {
                console.error('Signup error:', error);
                errorDiv.textContent = error.message || 'Failed to create account. Please try again.';
                errorDiv.classList.add('visible');
                btn.disabled = false;
                btn.textContent = 'Create Account';
            }
        }

        // Handle logout
        async function handleLogout() {
            if (!isSupabaseConfigured()) {
                localStorage.removeItem('eos-data-backup');
                location.reload();
                return;
            }

            try {
                // Unsubscribe from realtime
                if (realtimeChannel) {
                    await supabaseClient.removeChannel(realtimeChannel);
                    realtimeChannel = null;
                }

                await supabaseClient.auth.signOut();
                currentUser = null;
                currentOrganization = null;
                appData = null;

                showAuthScreen();
            } catch (error) {
                console.error('Logout error:', error);
                showToast('Failed to sign out');
            }
        }

        // Show the main app
        function showApp() {
            document.getElementById('loadingOverlay').style.display = 'none';
            document.getElementById('authContainer').style.display = 'none';
            document.getElementById('appContainer').style.display = 'flex';
        }

        // Show auth screen
        function showAuthScreen() {
            document.getElementById('loadingOverlay').style.display = 'none';
            document.getElementById('authContainer').style.display = 'flex';
            document.getElementById('appContainer').style.display = 'none';
            showLoginForm();
        }

        // Show local-only mode message
        function showLocalOnlyMode() {
            document.getElementById('loginError').textContent = 'Running in local-only mode. Configure Supabase credentials in the code to enable multi-user sync.';
            document.getElementById('loginError').classList.add('visible');
        }

        // Update user UI
        function updateUserUI() {
            if (currentUser) {
                const name = currentUser.user_metadata?.name || currentUser.email?.split('@')[0] || 'User';
                const initials = name.split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);

                document.getElementById('userAvatar').textContent = initials;
                document.getElementById('userName').textContent = name;
                document.getElementById('userEmail').textContent = currentUser.email || '';
            }
        }

        // Get current user's organization
        async function getCurrentOrganization() {
            if (!isSupabaseConfigured() || !currentUser) return null;

            try {
                const { data, error } = await supabaseClient
                    .from('organization_members')
                    .select('organization_id, organizations(id, name)')
                    .eq('user_id', currentUser.id)
                    .single();

                if (error) throw error;

                return data?.organizations || null;
            } catch (error) {
                console.error('Error fetching organization:', error);
                return null;
            }
        }

        // Get team members for owner dropdowns
        async function getTeamMembers() {
            if (!isSupabaseConfigured() || !currentOrganization) {
                // Return default members for local mode
                return [
                    { id: null, name: 'Joel' },
                    { id: null, name: 'Lee' }
                ];
            }

            try {
                const { data, error } = await supabase
                    .from('organization_members')
                    .select('user_id, profiles(id, name, email)')
                    .eq('organization_id', currentOrganization.id);

                if (error) throw error;

                return data.map(m => ({
                    id: m.profiles.id,
                    name: m.profiles.name || m.profiles.email?.split('@')[0],
                    email: m.profiles.email
                }));
            } catch (error) {
                console.error('Error fetching team members:', error);
                return [{ id: null, name: 'Joel' }, { id: null, name: 'Lee' }];
            }
        }

        // =====================================================
        // ONLINE/OFFLINE HANDLING
        // =====================================================
        window.addEventListener('online', () => {
            isOnline = true;
            document.getElementById('offlineIndicator').classList.remove('visible');
            syncPendingChanges();
        });

        window.addEventListener('offline', () => {
            isOnline = false;
            document.getElementById('offlineIndicator').classList.add('visible');
        });

        async function syncPendingChanges() {
            if (!isSupabaseConfigured() || pendingChanges.length === 0) return;

            const changes = [...pendingChanges];
            pendingChanges = [];

            for (const change of changes) {
                try {
                    await change();
                } catch (error) {
                    console.error('Error syncing change:', error);
                    pendingChanges.push(change);
                }
            }

            if (pendingChanges.length === 0) {
                showToast('Changes synced');
            }
        }

        // Update sync indicator
        function setSyncStatus(status) {
            const dot = document.getElementById('syncDot');
            const text = document.getElementById('syncText');

            if (status === 'syncing') {
                dot.classList.add('syncing');
                text.textContent = 'Syncing...';
            } else if (status === 'synced') {
                dot.classList.remove('syncing');
                text.textContent = 'Synced';
            } else if (status === 'offline') {
                dot.classList.remove('syncing');
                text.textContent = 'Offline';
            }
        }

        const meetingSections = [
            { name: 'Segue', duration: 5, description: 'Good news - personal and professional wins' },
            { name: 'Scorecard', duration: 5, description: 'Review metrics and identify off-track items' },
            { name: 'Rock Review', duration: 5, description: 'Update progress on quarterly priorities' },
            { name: 'Headlines', duration: 5, description: 'Customer and employee updates' },
            { name: 'To-Do Review', duration: 5, description: 'Check last week\'s commitments' },
            { name: 'IDS', duration: 60, description: 'Identify, Discuss, Solve top issues' },
            { name: 'Conclude', duration: 5, description: 'Recap, commitments, and rate the meeting' }
        ];

        // Initialize Application
        // =====================================================
        // INITIALIZATION
        // =====================================================
        async function init() {
            // Check if Supabase is configured
            if (isSupabaseConfigured()) {
                // Set up auth state listener
                supabaseClient.auth.onAuthStateChange(async (event, session) => {
                    console.log('Auth state changed:', event);

                    if (session?.user) {
                        currentUser = session.user;
                        currentOrganization = await getCurrentOrganization();

                        if (currentOrganization) {
                            await loadData();
                            updateUserUI();
                            setupRealtimeSubscriptions();
                            showApp();
                            initializeApp();
                        } else {
                            // User has no organization - this shouldn't happen with our trigger
                            console.error('User has no organization');
                            showAuthScreen();
                        }
                    } else {
                        currentUser = null;
                        currentOrganization = null;
                        showAuthScreen();
                    }
                });

                // Check initial session
                const { data: { session } } = await supabaseClient.auth.getSession();
                if (!session) {
                    showAuthScreen();
                }
            } else {
                // Local-only mode - load data and show app directly
                console.log('Running in local-only mode');
                await loadData();
                showApp();
                initializeApp();
            }
        }

        // Initialize app after data is loaded
        function initializeApp() {
            renderAll();
            setupEventListeners();
            setupKeyboardShortcuts();

            // Apply saved dark mode preference
            if (appData.settings?.darkMode) {
                document.body.classList.add('dark-mode');
                document.getElementById('darkModeIcon').innerHTML = '&#9728;';
                document.getElementById('darkModeText').textContent = 'Light Mode';
            }

            // Check for saved meeting in progress
            checkForSavedMeeting();
        }

        // =====================================================
        // REALTIME SUBSCRIPTIONS
        // =====================================================
        function setupRealtimeSubscriptions() {
            if (!isSupabaseConfigured() || !currentOrganization) return;

            // Remove existing channel if any
            if (realtimeChannel) {
                supabaseClient.removeChannel(realtimeChannel);
            }

            // Subscribe to all relevant tables
            realtimeChannel = supabaseClient
                .channel('eos-changes')
                .on(
                    'postgres_changes',
                    {
                        event: '*',
                        schema: 'public',
                        table: 'scorecard_metrics',
                        filter: `organization_id=eq.${currentOrganization.id}`
                    },
                    (payload) => handleRealtimeChange('metrics', payload)
                )
                .on(
                    'postgres_changes',
                    {
                        event: '*',
                        schema: 'public',
                        table: 'rocks',
                        filter: `organization_id=eq.${currentOrganization.id}`
                    },
                    (payload) => handleRealtimeChange('rocks', payload)
                )
                .on(
                    'postgres_changes',
                    {
                        event: '*',
                        schema: 'public',
                        table: 'issues',
                        filter: `organization_id=eq.${currentOrganization.id}`
                    },
                    (payload) => handleRealtimeChange('issues', payload)
                )
                .on(
                    'postgres_changes',
                    {
                        event: '*',
                        schema: 'public',
                        table: 'todos',
                        filter: `organization_id=eq.${currentOrganization.id}`
                    },
                    (payload) => handleRealtimeChange('todos', payload)
                )
                .on(
                    'postgres_changes',
                    {
                        event: '*',
                        schema: 'public',
                        table: 'meetings',
                        filter: `organization_id=eq.${currentOrganization.id}`
                    },
                    (payload) => handleRealtimeChange('meetings', payload)
                )
                .on(
                    'postgres_changes',
                    {
                        event: '*',
                        schema: 'public',
                        table: 'vision',
                        filter: `organization_id=eq.${currentOrganization.id}`
                    },
                    (payload) => handleRealtimeChange('vision', payload)
                )
                .subscribe((status) => {
                    console.log('Realtime subscription status:', status);
                    if (status === 'SUBSCRIBED') {
                        setSyncStatus('synced');
                    }
                });
        }

        // Handle realtime changes from other users
        function handleRealtimeChange(table, payload) {
            console.log('Realtime change:', table, payload.eventType);

            // Reload data and re-render affected views
            // Using debounce to avoid too many reloads
            clearTimeout(window.realtimeDebounce);
            window.realtimeDebounce = setTimeout(async () => {
                await loadDataFromSupabase();
                localStorage.setItem('eos-data-backup', JSON.stringify(appData));

                // Re-render affected views
                switch (table) {
                    case 'metrics':
                        renderScorecard();
                        renderDashboard();
                        break;
                    case 'rocks':
                        renderRocks();
                        renderDashboard();
                        break;
                    case 'issues':
                        renderIssues();
                        renderDashboard();
                        break;
                    case 'todos':
                        renderTodos();
                        renderDashboard();
                        break;
                    case 'meetings':
                        renderMeetingHistory();
                        renderDashboard();
                        break;
                    case 'vision':
                        renderVision();
                        break;
                    default:
                        renderAll();
                }

                showToast('Data updated by another user');
            }, 500);
        }

        // Embedded default data (works without server)
        const EMBEDDED_DATA = {"meta":{"version":"1.0","lastUpdated":"2026-01-22T09:30:00Z","currentQuarter":"Q1-2026"},"scorecard":{"metrics":[{"id":"revenue-growth","name":"Net revenue vs last year","owner":"Joel","goal":"2% weekly","current":null,"status":"green","history":[],"notes":"Handles seasonality naturally"},{"id":"contribution-margin","name":"Contribution margin after fulfilment","owner":"Lee","goal":"TBD","current":null,"status":"yellow","history":[],"notes":"Needs defining - profitability metric"},{"id":"conversion-rate","name":"Conversion rate (site-wide)","owner":"Joel","goal":"3%","current":null,"status":"green","history":[],"notes":"Combined brands"},{"id":"aov","name":"Average order value (AOV)","owner":"Joel","goal":"£50","current":null,"status":"green","history":[],"notes":"Updated from £40"},{"id":"cac","name":"Paid media efficiency (Blended CAC)","owner":"Joel","goal":"£15","current":null,"status":"green","history":[],"notes":"2029 target, allow £20 in 2026"},{"id":"shipping","name":"Orders shipped on time (%)","owner":"Lee","goal":"100%","current":null,"status":"green","history":[],"notes":"Operations excellence"},{"id":"returns","name":"Refund and return rate","owner":"Lee","goal":"0.5%","current":null,"status":"green","history":[],"notes":"Quality metric"},{"id":"support-tickets","name":"Customer support tickets per 100 orders","owner":"Joel","goal":"10","current":null,"status":"green","history":[],"notes":"Customer experience"},{"id":"inventory","name":"Inventory health indicator","owner":"Lee","goal":"6 months","current":null,"status":"green","history":[],"notes":"Supply chain health"},{"id":"cash-runway","name":"Cash runway (months)","owner":"Lee","goal":"12 months","current":null,"status":"green","history":[],"notes":"Financial security"}]},"rocks":[{"id":"rock-1","title":"Team & Capacity Foundation","owner":"Joel","progress":0,"status":"on-track","dueDate":"2026-03-31","milestones":[{"id":"m1-1","text":"Hire Content & Brand Manager for Bright Ivy","completed":false},{"id":"m1-2","text":"Content & Brand Manager onboarded by 31 March","completed":false},{"id":"m1-3","text":"Production staff hired","completed":false},{"id":"m1-4","text":"Production staff trained and ready to start Q2","completed":false}],"notes":""},{"id":"rock-2","title":"Product Development & Launch","owner":"Lee","progress":0,"status":"on-track","dueDate":"2026-03-31","milestones":[{"id":"m2-1","text":"Larger case sizes launched for both brands","completed":false},{"id":"m2-2","text":"Packaging finalised for Bright Ivy","completed":false},{"id":"m2-3","text":"Packaging finalised for Display Champ","completed":false},{"id":"m2-4","text":"2026 product roadmap signed off","completed":false},{"id":"m2-5","text":"Further golf product development completed","completed":false}],"notes":""},{"id":"rock-3","title":"Market Expansion - Display Champ","owner":"Lee","progress":0,"status":"on-track","dueDate":"2026-03-31","milestones":[{"id":"m3-1","text":"Tennis market opened and live","completed":false},{"id":"m3-2","text":"Baseball market opened and live","completed":false},{"id":"m3-3","text":"Ice hockey market opened and live","completed":false},{"id":"m3-4","text":"Cricket market opened and live","completed":false},{"id":"m3-5","text":"First sales in each new sport vertical","completed":false}],"notes":""},{"id":"rock-4","title":"Strategic Planning Complete","owner":"Joel","progress":0,"status":"on-track","dueDate":"2026-03-31","milestones":[{"id":"m4-1","text":"SEO plan signed off","completed":false},{"id":"m4-2","text":"SEO content production started","completed":false},{"id":"m4-3","text":"Content plan signed off","completed":false},{"id":"m4-4","text":"Content production started","completed":false}],"notes":""},{"id":"rock-5","title":"Systems & Operations","owner":"Joel","progress":0,"status":"on-track","dueDate":"2026-03-31","milestones":[{"id":"m5-1","text":"Capacity planning built","completed":false},{"id":"m5-2","text":"Capacity reporting automated","completed":false},{"id":"m5-3","text":"Financial reporting automation implemented","completed":false},{"id":"m5-4","text":"ERP scoping completed","completed":false}],"notes":"ERP implementation Q2+"},{"id":"rock-6","title":"Bright Ivy Website Optimisation","owner":"Lee","progress":0,"status":"on-track","dueDate":"2026-03-31","milestones":[{"id":"m6-1","text":"Conversion rate improvements implemented","completed":false},{"id":"m6-2","text":"Load speed optimised","completed":false},{"id":"m6-3","text":"Checkout flow optimised","completed":false},{"id":"m6-4","text":"Messaging optimised","completed":false}],"notes":""}],"issues":[{"id":"issue-1","title":"Define Lee's contribution margin goal for scorecard","source":"scorecard","priority":1,"status":"open","createdDate":"2026-01-22","notes":"","linkedTodos":[]},{"id":"issue-2","title":"Factory space planning for 4 UV machines by 2029","source":"other","priority":2,"status":"open","createdDate":"2026-01-22","notes":"Need to accommodate 4 UV machines + 15-16 assembly workstations","linkedTodos":[]},{"id":"issue-3","title":"Second UV machine purchase timeline","source":"other","priority":3,"status":"open","createdDate":"2026-01-22","notes":"Need for redundancy and 2027 growth","linkedTodos":[]},{"id":"issue-4","title":"Core values documentation","source":"other","priority":4,"status":"open","createdDate":"2026-01-22","notes":"If not already established","linkedTodos":[]},{"id":"issue-5","title":"Accountability chart creation","source":"other","priority":5,"status":"open","createdDate":"2026-01-22","notes":"Who does what by role","linkedTodos":[]},{"id":"issue-6","title":"International shipping cost optimisation","source":"other","priority":6,"status":"open","createdDate":"2026-01-22","notes":"","linkedTodos":[]},{"id":"issue-7","title":"B2B channel development strategy","source":"other","priority":7,"status":"open","createdDate":"2026-01-22","notes":"","linkedTodos":[]}],"todos":[{"id":"todo-1","title":"Begin weekly Level 10 meetings (Mondays 9:30am)","owner":"Joel","dueDate":"2026-01-27","status":"pending","carriedForwardCount":0,"notes":"","linkedIssueId":null},{"id":"todo-2","title":"Track Q1 Rocks progress weekly (green/yellow/red status)","owner":"Joel","dueDate":"2026-01-27","status":"pending","carriedForwardCount":0,"notes":"","linkedIssueId":null},{"id":"todo-3","title":"Build Issues List as topics arise","owner":"Joel","dueDate":"2026-01-27","status":"pending","carriedForwardCount":0,"notes":"","linkedIssueId":null}],"meetings":[],"vision":{"tenYear":{"target":"2036","description":"1 million customers served annually across global markets, £50M revenue, with autonomous teams operating both businesses whilst founders provide strategic oversight only, recognised as the world's premium memory preservation brand"},"threeYear":{"target":"2029","revenue":"£10M","customers":"200,000 annually","split":{"brightIvy":"70% (£7M)","displayChamp":"30% (£3M)"},"geography":{"uk":"60% (£6M)","northAmerica":"17.5% (£1.75M)","australia":"17.5% (£1.75M)","europe":"5% (£500K)"},"team":{"total":"30-33 people","operations":"22-25 people","contentBrand":"3-4 people","marketing":"2 people","customerService":"1 person","financeAdmin":"2 people"},"metrics":{"cac":"<£15","repeatRate":"10% every 60 days","grossMargin":"70%","netMargin":"25% (£2.5M profit)","cashReserves":"£3M"}},"oneYear":{"target":"2026","revenue":"£2.1M","split":{"brightIvy":"£1.5M (71%)","displayChamp":"£600K (29%)"},"profit":{"grossMargin":"70% (£1.47M)","netMargin":"25% (£525K)"},"quarterly":{"q1":"£420K (20%)","q2":"£420K (20%)","q3":"£420K (20%)","q4":"£840K (40%)"},"goals":[{"id":"goal-1","title":"Customer Acquisition & Retention","targets":["Serve 42,000 customers","Achieve 10% repeat rate every 60 days","CAC under £20"]},{"id":"goal-2","title":"Team & Capability Building","targets":["Hire and onboard Content & Brand Manager for Bright Ivy","Produce 50+ customer story videos across both brands","Operations team scaled to handle 42K annual capacity"]},{"id":"goal-3","title":"Market Expansion Foundation","targets":["Launch North America - achieve £100K revenue (5%)","Australia operational - achieve £100K revenue (5%)","UK: £1.9M (90% of revenue)"]},{"id":"goal-4","title":"Content & Marketing Engine","targets":["Complete influencer campaigns (fossils, coins, parenting) and measure ROAS","Google Ads: £50K spend generating 3x+ ROAS","SEO content published for top 15 identified opportunities"]},{"id":"goal-5","title":"Systems & Automation Foundations","targets":["ERP scoped and implementation begun","Customer story capture process systemised","Automated reporting for key metrics (revenue, CAC, repeat rate, inventory)"]},{"id":"goal-6","title":"Product & Manufacturing","targets":["Second UV machine purchased and operational","Laser capacity assessed for 2027 scaling needs","Quality control processes documented"]},{"id":"goal-7","title":"Geographic Revenue Distribution Achievement","targets":["UK: 90% (£1.9M)","North America: 5% (£100K)","Australia: 5% (£100K)"]}]},"coreFocus":{"purpose":"Enable people to tell and display the stories that matter most to them","passion":"Seeing the impact our displays have on customers' lives through their stories and feedback","niche":"Premium custom display cases that transform cherished items into conversation-starting centrepieces"}},"settings":{"darkMode":false,"meetingDay":"Monday","meetingTime":"09:30"}};

        // Load Data - tries localStorage first, then embedded data
        // =====================================================
        // LOAD DATA - From Supabase or localStorage fallback
        // =====================================================
        async function loadData() {
            // If Supabase is configured and we have an organization, load from database
            if (isSupabaseConfigured() && currentOrganization) {
                try {
                    await loadDataFromSupabase();
                    console.log('Loaded from Supabase');
                    return;
                } catch (error) {
                    console.error('Error loading from Supabase:', error);
                    // Fall through to localStorage
                }
            }

            // Fallback: Try localStorage backup
            const backup = localStorage.getItem('eos-data-backup');
            if (backup) {
                try {
                    appData = JSON.parse(backup);
                    console.log('Loaded from localStorage backup');
                    return;
                } catch (e) {
                    console.warn('Failed to parse localStorage backup');
                }
            }

            // Final fallback: Use embedded data
            appData = JSON.parse(JSON.stringify(EMBEDDED_DATA));
            console.log('Loaded from embedded data');
        }

        // Load all data from Supabase
        async function loadDataFromSupabase() {
            const orgId = currentOrganization.id;

            // Fetch all data in parallel
            const [
                metricsRes,
                rocksRes,
                milestonesRes,
                issuesRes,
                todosRes,
                meetingsRes,
                visionRes,
                settingsRes
            ] = await Promise.all([
                supabaseClient.from('scorecard_metrics').select('*').eq('organization_id', orgId).order('sort_order'),
                supabaseClient.from('rocks').select('*').eq('organization_id', orgId).order('sort_order'),
                supabaseClient.from('rock_milestones').select('*').order('sort_order'),
                supabaseClient.from('issues').select('*').eq('organization_id', orgId).order('priority'),
                supabaseClient.from('todos').select('*').eq('organization_id', orgId).order('created_at'),
                supabaseClient.from('meetings').select('*').eq('organization_id', orgId).order('date', { ascending: false }),
                supabaseClient.from('vision').select('*').eq('organization_id', orgId).single(),
                supabaseClient.from('settings').select('*').eq('organization_id', orgId).single()
            ]);

            // Fetch metric history for sparklines
            const metricIds = metricsRes.data?.map(m => m.id) || [];
            let historyData = [];
            if (metricIds.length > 0) {
                const historyRes = await supabase
                    .from('metric_history')
                    .select('*')
                    .in('metric_id', metricIds)
                    .order('week_date');
                historyData = historyRes.data || [];
            }

            // Transform data to match app's expected format
            const metrics = (metricsRes.data || []).map(m => ({
                id: m.id,
                name: m.name,
                owner: m.owner_name || 'Unassigned',
                goal: m.goal,
                current: m.current,
                status: m.status,
                notes: m.notes,
                history: historyData
                    .filter(h => h.metric_id === m.id)
                    .map(h => ({ date: h.week_date, value: h.value }))
            }));

            const milestonesMap = {};
            (milestonesRes.data || []).forEach(m => {
                if (!milestonesMap[m.rock_id]) milestonesMap[m.rock_id] = [];
                milestonesMap[m.rock_id].push({
                    id: m.id,
                    text: m.text,
                    completed: m.completed
                });
            });

            const rocks = (rocksRes.data || []).map(r => ({
                id: r.id,
                title: r.title,
                owner: r.owner_name || 'Unassigned',
                progress: r.progress,
                status: r.status,
                dueDate: r.due_date,
                notes: r.notes,
                milestones: milestonesMap[r.id] || []
            }));

            const issues = (issuesRes.data || []).map(i => ({
                id: i.id,
                title: i.title,
                source: i.source,
                priority: i.priority,
                status: i.status,
                createdDate: i.created_date,
                notes: i.notes,
                linkedTodos: []
            }));

            const todos = (todosRes.data || []).map(t => ({
                id: t.id,
                title: t.title,
                owner: t.owner_name || 'Unassigned',
                dueDate: t.due_date,
                status: t.status,
                carriedForwardCount: t.carried_forward_count,
                notes: t.notes,
                linkedIssueId: t.linked_issue_id
            }));

            const meetings = (meetingsRes.data || []).map(m => ({
                id: m.id,
                date: m.date,
                rating: m.rating,
                issuesSolved: m.issues_solved,
                todosCreated: m.todos_created,
                notes: m.notes
            }));

            const visionData = visionRes.data || {};
            const vision = {
                tenYear: {
                    target: visionData.ten_year_target || '2036',
                    description: visionData.ten_year_description || ''
                },
                threeYear: visionData.three_year || {},
                oneYear: visionData.one_year || {},
                coreFocus: visionData.core_focus || {}
            };

            const settingsData = settingsRes.data || {};
            const settings = {
                darkMode: settingsData.dark_mode || false,
                meetingDay: settingsData.meeting_day || 'Monday',
                meetingTime: settingsData.meeting_time || '09:30'
            };

            // Construct appData
            appData = {
                meta: {
                    version: '1.0',
                    lastUpdated: new Date().toISOString(),
                    currentQuarter: settingsData.current_quarter || 'Q1-2026'
                },
                scorecard: { metrics },
                rocks,
                issues,
                todos,
                meetings,
                vision,
                settings
            };

            // Also save to localStorage as backup
            localStorage.setItem('eos-data-backup', JSON.stringify(appData));
        }

        // =====================================================
        // SAVE DATA - To Supabase and localStorage
        // =====================================================
        async function saveData() {
            clearTimeout(saveTimeout);
            saveTimeout = setTimeout(async () => {
                appData.meta.lastUpdated = new Date().toISOString();

                // Always save to localStorage as backup
                localStorage.setItem('eos-data-backup', JSON.stringify(appData));

                // Show save indicator
                const indicator = document.getElementById('saveIndicator');
                indicator.classList.add('active');
                setTimeout(() => indicator.classList.remove('active'), 2000);

                // If Supabase configured and online, sync will happen via specific save functions
                // The individual update functions below handle Supabase sync
                console.log('Data saved to localStorage backup');
            }, 500);
        }

        // =====================================================
        // SUPABASE SPECIFIC SAVE FUNCTIONS
        // =====================================================

        // Save a single metric to Supabase
        async function saveMetricToSupabase(metric) {
            if (!isSupabaseConfigured() || !currentOrganization) return;

            setSyncStatus('syncing');
            try {
                const { error } = await supabase
                    .from('scorecard_metrics')
                    .upsert({
                        id: metric.id,
                        organization_id: currentOrganization.id,
                        name: metric.name,
                        owner_name: metric.owner,
                        goal: metric.goal,
                        current: metric.current,
                        status: metric.status,
                        notes: metric.notes
                    });

                if (error) throw error;
                setSyncStatus('synced');
            } catch (error) {
                console.error('Error saving metric:', error);
                setSyncStatus('offline');
                if (!isOnline) {
                    pendingChanges.push(() => saveMetricToSupabase(metric));
                }
            }
        }

        // Save a rock to Supabase
        async function saveRockToSupabase(rock) {
            if (!isSupabaseConfigured() || !currentOrganization) return;

            setSyncStatus('syncing');
            try {
                // Save rock
                const { error: rockError } = await supabase
                    .from('rocks')
                    .upsert({
                        id: rock.id,
                        organization_id: currentOrganization.id,
                        title: rock.title,
                        owner_name: rock.owner,
                        progress: rock.progress,
                        status: rock.status,
                        due_date: rock.dueDate,
                        notes: rock.notes
                    });

                if (rockError) throw rockError;

                // Save milestones
                if (rock.milestones && rock.milestones.length > 0) {
                    const milestoneData = rock.milestones.map((m, index) => ({
                        id: m.id,
                        rock_id: rock.id,
                        text: m.text,
                        completed: m.completed,
                        sort_order: index
                    }));

                    const { error: milestoneError } = await supabase
                        .from('rock_milestones')
                        .upsert(milestoneData);

                    if (milestoneError) throw milestoneError;
                }

                setSyncStatus('synced');
            } catch (error) {
                console.error('Error saving rock:', error);
                setSyncStatus('offline');
                if (!isOnline) {
                    pendingChanges.push(() => saveRockToSupabase(rock));
                }
            }
        }

        // Delete a rock from Supabase
        async function deleteRockFromSupabase(rockId) {
            if (!isSupabaseConfigured() || !currentOrganization) return;

            setSyncStatus('syncing');
            try {
                const { error } = await supabase
                    .from('rocks')
                    .delete()
                    .eq('id', rockId);

                if (error) throw error;
                setSyncStatus('synced');
            } catch (error) {
                console.error('Error deleting rock:', error);
                setSyncStatus('offline');
            }
        }

        // Save an issue to Supabase
        async function saveIssueToSupabase(issue) {
            if (!isSupabaseConfigured() || !currentOrganization) return;

            setSyncStatus('syncing');
            try {
                const { error } = await supabase
                    .from('issues')
                    .upsert({
                        id: issue.id,
                        organization_id: currentOrganization.id,
                        title: issue.title,
                        source: issue.source,
                        priority: issue.priority,
                        status: issue.status,
                        notes: issue.notes,
                        created_date: issue.createdDate
                    });

                if (error) throw error;
                setSyncStatus('synced');
            } catch (error) {
                console.error('Error saving issue:', error);
                setSyncStatus('offline');
                if (!isOnline) {
                    pendingChanges.push(() => saveIssueToSupabase(issue));
                }
            }
        }

        // Delete an issue from Supabase
        async function deleteIssueFromSupabase(issueId) {
            if (!isSupabaseConfigured() || !currentOrganization) return;

            setSyncStatus('syncing');
            try {
                const { error } = await supabase
                    .from('issues')
                    .delete()
                    .eq('id', issueId);

                if (error) throw error;
                setSyncStatus('synced');
            } catch (error) {
                console.error('Error deleting issue:', error);
                setSyncStatus('offline');
            }
        }

        // Save a todo to Supabase
        async function saveTodoToSupabase(todo) {
            if (!isSupabaseConfigured() || !currentOrganization) return;

            setSyncStatus('syncing');
            try {
                const { error } = await supabase
                    .from('todos')
                    .upsert({
                        id: todo.id,
                        organization_id: currentOrganization.id,
                        title: todo.title,
                        owner_name: todo.owner,
                        due_date: todo.dueDate,
                        status: todo.status,
                        carried_forward_count: todo.carriedForwardCount,
                        notes: todo.notes,
                        linked_issue_id: todo.linkedIssueId
                    });

                if (error) throw error;
                setSyncStatus('synced');
            } catch (error) {
                console.error('Error saving todo:', error);
                setSyncStatus('offline');
                if (!isOnline) {
                    pendingChanges.push(() => saveTodoToSupabase(todo));
                }
            }
        }

        // Delete a todo from Supabase
        async function deleteTodoFromSupabase(todoId) {
            if (!isSupabaseConfigured() || !currentOrganization) return;

            setSyncStatus('syncing');
            try {
                const { error } = await supabase
                    .from('todos')
                    .delete()
                    .eq('id', todoId);

                if (error) throw error;
                setSyncStatus('synced');
            } catch (error) {
                console.error('Error deleting todo:', error);
                setSyncStatus('offline');
            }
        }

        // Save a meeting to Supabase
        async function saveMeetingToSupabase(meeting) {
            if (!isSupabaseConfigured() || !currentOrganization) return;

            setSyncStatus('syncing');
            try {
                const { error } = await supabase
                    .from('meetings')
                    .upsert({
                        id: meeting.id,
                        organization_id: currentOrganization.id,
                        date: meeting.date,
                        rating: meeting.rating,
                        issues_solved: meeting.issuesSolved,
                        todos_created: meeting.todosCreated,
                        notes: meeting.notes
                    });

                if (error) throw error;
                setSyncStatus('synced');
            } catch (error) {
                console.error('Error saving meeting:', error);
                setSyncStatus('offline');
                if (!isOnline) {
                    pendingChanges.push(() => saveMeetingToSupabase(meeting));
                }
            }
        }

        // Delete a meeting from Supabase
        async function deleteMeetingFromSupabase(meetingId) {
            if (!isSupabaseConfigured() || !currentOrganization) return;

            setSyncStatus('syncing');
            try {
                const { error } = await supabase
                    .from('meetings')
                    .delete()
                    .eq('id', meetingId);

                if (error) throw error;
                setSyncStatus('synced');
            } catch (error) {
                console.error('Error deleting meeting:', error);
                setSyncStatus('offline');
            }
        }

        // Save vision to Supabase
        async function saveVisionToSupabase() {
            if (!isSupabaseConfigured() || !currentOrganization) return;

            setSyncStatus('syncing');
            try {
                const { error } = await supabase
                    .from('vision')
                    .upsert({
                        organization_id: currentOrganization.id,
                        ten_year_target: appData.vision.tenYear?.target,
                        ten_year_description: appData.vision.tenYear?.description,
                        three_year: appData.vision.threeYear,
                        one_year: appData.vision.oneYear,
                        core_focus: appData.vision.coreFocus
                    });

                if (error) throw error;
                setSyncStatus('synced');
            } catch (error) {
                console.error('Error saving vision:', error);
                setSyncStatus('offline');
            }
        }

        // Save settings to Supabase
        async function saveSettingsToSupabase() {
            if (!isSupabaseConfigured() || !currentOrganization) return;

            setSyncStatus('syncing');
            try {
                const { error } = await supabase
                    .from('settings')
                    .upsert({
                        organization_id: currentOrganization.id,
                        dark_mode: appData.settings.darkMode,
                        meeting_day: appData.settings.meetingDay,
                        meeting_time: appData.settings.meetingTime,
                        current_quarter: appData.meta.currentQuarter
                    });

                if (error) throw error;
                setSyncStatus('synced');
            } catch (error) {
                console.error('Error saving settings:', error);
                setSyncStatus('offline');
            }
        }

        // Save all issues priorities after reorder
        async function saveIssuesPrioritiesToSupabase() {
            if (!isSupabaseConfigured() || !currentOrganization) return;

            setSyncStatus('syncing');
            try {
                const updates = appData.issues.map((issue, index) => ({
                    id: issue.id,
                    organization_id: currentOrganization.id,
                    priority: index + 1
                }));

                for (const update of updates) {
                    await supabase
                        .from('issues')
                        .update({ priority: update.priority })
                        .eq('id', update.id);
                }

                setSyncStatus('synced');
            } catch (error) {
                console.error('Error saving issue priorities:', error);
                setSyncStatus('offline');
            }
        }

        // Get Default Data Structure
        function getDefaultData() {
            return {
                meta: { version: "1.0", lastUpdated: new Date().toISOString(), currentQuarter: "Q1-2026" },
                scorecard: { metrics: [] },
                rocks: [],
                issues: [],
                todos: [],
                meetings: [],
                vision: {},
                settings: { darkMode: false }
            };
        }

        // Render All Views
        function renderAll() {
            renderDashboard();
            renderScorecard();
            renderRocks();
            renderIssues();
            renderTodos();
            renderVision();
            renderMeetingHistory();
        }

        // Dashboard Rendering
        function renderDashboard() {
            // Calculate meeting stats
            const meetingStats = calculateMeetingStats();

            // Stats
            const statsHtml = `
                <div class="stat-card">
                    <div class="stat-label">Q1 Target</div>
                    <div class="stat-value">£420K</div>
                    <div class="stat-trend">Jan-Mar 2026</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Annual Target</div>
                    <div class="stat-value">£2.1M</div>
                    <div class="stat-trend">2026 Goal</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Rocks Progress</div>
                    <div class="stat-value">${calculateOverallRockProgress()}%</div>
                    <div class="stat-trend">${appData.rocks.filter(r => r.status === 'on-track').length}/${appData.rocks.length} on track</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Open Issues</div>
                    <div class="stat-value">${appData.issues.filter(i => i.status === 'open').length}</div>
                    <div class="stat-trend">To solve</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Avg Meeting Rating</div>
                    <div class="stat-value">${meetingStats.avgRating}</div>
                    <div class="stat-trend">${meetingStats.totalMeetings} meetings held</div>
                </div>
            `;
            document.getElementById('dashboardStats').innerHTML = statsHtml;

            // Focus Items (pending to-dos for this week)
            const pendingTodos = appData.todos.filter(t => t.status === 'pending').slice(0, 3);
            const focusHtml = pendingTodos.length > 0 ? pendingTodos.map((todo, i) => `
                <div class="focus-item">
                    <div class="focus-number">${i + 1}</div>
                    <div>
                        <div>${todo.title}</div>
                        <div style="font-size: 0.75rem; color: var(--text-muted);">${todo.owner} · Due ${formatDate(todo.dueDate)}</div>
                    </div>
                </div>
            `).join('') : '<div class="focus-item">No pending to-dos - all caught up!</div>';
            document.getElementById('focusItems').innerHTML = focusHtml;

            // Scorecard Snapshot - now shows all 10 metrics with scrollable container
            const scorecardHtml = `
                <div style="max-height: 300px; overflow-y: auto;">
                    ${appData.scorecard.metrics.map(metric => `
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.5rem 0; border-bottom: 1px solid var(--subtle-border);">
                            <span style="font-size: 0.875rem;">${metric.name}</span>
                            <span class="status-badge status-${metric.status}">
                                <span class="status-dot ${metric.status}"></span>
                                ${metric.status}
                            </span>
                        </div>
                    `).join('')}
                </div>
            `;
            document.getElementById('scorecardSnapshot').innerHTML = scorecardHtml;

            // Rocks Snapshot
            const rocksHtml = appData.rocks.map(rock => `
                <div style="margin-bottom: 1rem;">
                    <div style="display: flex; justify-content: space-between; font-size: 0.875rem; margin-bottom: 0.25rem;">
                        <span>${rock.title}</span>
                        <span style="font-family: var(--font-mono);">${rock.progress}%</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill ${getStatusColor(rock.status)}" style="width: ${rock.progress}%;"></div>
                    </div>
                </div>
            `).join('');
            document.getElementById('rocksSnapshot').innerHTML = rocksHtml;

            // Check for paused meeting and show banner if exists
            showPausedMeetingBanner();
        }

        // Calculate Meeting Stats
        function calculateMeetingStats() {
            const meetings = appData.meetings || [];
            if (meetings.length === 0) {
                return { avgRating: '-', totalMeetings: 0, recentMeetings: [] };
            }

            const totalRating = meetings.reduce((sum, m) => sum + m.rating, 0);
            const avgRating = (totalRating / meetings.length).toFixed(1);
            const recentMeetings = meetings.slice(-4).reverse();

            return {
                avgRating,
                totalMeetings: meetings.length,
                recentMeetings,
                totalIssuesSolved: meetings.reduce((sum, m) => sum + (m.issuesSolved || 0), 0),
                totalTodosCreated: meetings.reduce((sum, m) => sum + (m.todosCreated || 0), 0)
            };
        }

        // Scorecard Rendering
        function renderScorecard() {
            const html = appData.scorecard.metrics.map(metric => `
                <tr data-id="${metric.id}">
                    <td>
                        <div style="font-weight: 500;">${metric.name}</div>
                        <div style="font-size: 0.75rem; color: var(--text-muted);">${metric.notes || ''}</div>
                    </td>
                    <td>${metric.owner}</td>
                    <td style="font-family: var(--font-mono);">${metric.goal}</td>
                    <td>
                        <span class="editable" contenteditable="true" onblur="updateMetricValue('${metric.id}', this.textContent)">
                            ${metric.current || '-'}
                        </span>
                    </td>
                    <td>
                        <select class="form-select" style="width: auto; padding: 0.25rem 0.5rem;" onchange="updateMetricStatus('${metric.id}', this.value)">
                            <option value="green" ${metric.status === 'green' ? 'selected' : ''}>Green</option>
                            <option value="yellow" ${metric.status === 'yellow' ? 'selected' : ''}>Yellow</option>
                            <option value="red" ${metric.status === 'red' ? 'selected' : ''}>Red</option>
                        </select>
                    </td>
                    <td>
                        <span class="sparkline">${generateSparkline(metric.history)}</span>
                    </td>
                    <td>
                        <button class="btn btn-sm btn-secondary card-edit-btn" onclick="openEditMetricModal('${metric.id}')" title="Edit metric">&#9998;</button>
                        <button class="btn btn-sm btn-secondary" onclick="dropToIssue('${metric.id}')">Drop to IDS</button>
                    </td>
                </tr>
            `).join('');
            document.getElementById('scorecardBody').innerHTML = html;
        }

        // Rocks Rendering
        function renderRocks(filter = 'all') {
            let rocks = appData.rocks;
            if (filter !== 'all') {
                rocks = rocks.filter(r => r.owner === filter);
            }

            const html = rocks.map(rock => {
                const completedMilestones = rock.milestones.filter(m => m.completed).length;
                const totalMilestones = rock.milestones.length;
                const daysLeft = Math.ceil((new Date(rock.dueDate) - new Date()) / (1000 * 60 * 60 * 24));

                return `
                <div class="rock-card animate-in">
                    <div class="rock-header">
                        <div>
                            <div class="rock-title">${rock.title}</div>
                            <div class="rock-owner">Owner: ${rock.owner}</div>
                        </div>
                        <div style="display: flex; gap: 0.5rem; align-items: center;">
                            <button class="btn btn-sm btn-secondary card-edit-btn" onclick="openEditRockModal('${rock.id}')" title="Edit rock">&#9998;</button>
                            <span class="status-badge status-${getStatusColor(rock.status)}">
                                ${formatStatus(rock.status)}
                            </span>
                        </div>
                    </div>

                    ${rock.notes ? `<div class="rock-notes">${rock.notes}</div>` : ''}

                    <div class="rock-progress">
                        <div class="rock-progress-label">
                            <span>Progress</span>
                            <span>${rock.progress}%</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill ${getStatusColor(rock.status)}" style="width: ${rock.progress}%;"></div>
                        </div>
                        <input type="range" min="0" max="100" value="${rock.progress}"
                            style="width: 100%; margin-top: 0.5rem;"
                            onchange="updateRockProgress('${rock.id}', this.value)">
                    </div>

                    <div class="rock-milestones">
                        <div style="font-size: 0.8rem; color: var(--text-muted); margin-bottom: 0.5rem;">
                            Milestones (${completedMilestones}/${totalMilestones})
                        </div>
                        ${rock.milestones.map(m => `
                            <div class="milestone-item">
                                <div class="milestone-checkbox ${m.completed ? 'checked' : ''}"
                                    onclick="toggleMilestone('${rock.id}', '${m.id}')">
                                    ${m.completed ? '&#10003;' : ''}
                                </div>
                                <span class="milestone-text ${m.completed ? 'completed' : ''}">${m.text}</span>
                            </div>
                        `).join('')}
                    </div>

                    <div class="rock-due">
                        <span>&#128197;</span>
                        <span>Due: ${formatDate(rock.dueDate)} (${daysLeft} days)</span>
                    </div>

                    <div style="margin-top: 1rem; display: flex; gap: 0.5rem;">
                        <select class="form-select" style="flex: 1;" onchange="updateRockStatus('${rock.id}', this.value)">
                            <option value="on-track" ${rock.status === 'on-track' ? 'selected' : ''}>On Track</option>
                            <option value="at-risk" ${rock.status === 'at-risk' ? 'selected' : ''}>At Risk</option>
                            <option value="off-track" ${rock.status === 'off-track' ? 'selected' : ''}>Off Track</option>
                        </select>
                    </div>
                </div>
            `}).join('');

            document.getElementById('rocksGrid').innerHTML = html || '<div class="empty-state"><div class="empty-state-icon">&#9670;</div><p>No rocks found</p></div>';
        }

        // Issues Rendering
        function renderIssues(filter = 'open') {
            let issues = appData.issues;
            if (filter !== 'all') {
                issues = issues.filter(i => i.status === filter);
            }

            const html = issues.map((issue, index) => `
                <div class="issue-item animate-in" draggable="true" data-id="${issue.id}"
                    ondragstart="dragStart(event)" ondragover="dragOver(event)" ondrop="drop(event)">
                    <div class="issue-priority">${index + 1}</div>
                    <div class="issue-content">
                        <div class="issue-title">${issue.title}</div>
                        <div class="issue-meta">
                            <span class="issue-source">${issue.source}</span>
                            <span>${formatDate(issue.createdDate)}</span>
                        </div>
                    </div>
                    <div class="issue-actions">
                        <select class="form-select" style="width: auto; padding: 0.25rem;" onchange="updateIssueStatus('${issue.id}', this.value)">
                            <option value="open" ${issue.status === 'open' ? 'selected' : ''}>Open</option>
                            <option value="in-discussion" ${issue.status === 'in-discussion' ? 'selected' : ''}>In Discussion</option>
                            <option value="resolved" ${issue.status === 'resolved' ? 'selected' : ''}>Resolved</option>
                        </select>
                        <button class="btn btn-sm btn-secondary" onclick="createTodoFromIssue('${issue.id}')">&#8594; To-Do</button>
                        <button class="btn btn-sm btn-secondary" onclick="deleteIssue('${issue.id}')">&#10005;</button>
                    </div>
                </div>
            `).join('');

            document.getElementById('issuesList').innerHTML = html || '<div class="empty-state"><div class="empty-state-icon">&#10003;</div><p>No issues - great work!</p></div>';
        }

        // Todos Rendering
        function renderTodos(filter = 'all') {
            let todos = appData.todos;
            if (filter === 'Joel' || filter === 'Lee') {
                todos = todos.filter(t => t.owner === filter);
            } else if (filter === 'pending') {
                todos = todos.filter(t => t.status === 'pending');
            } else if (filter === 'complete') {
                todos = todos.filter(t => t.status === 'complete');
            }

            const html = todos.map(todo => `
                <div class="todo-item animate-in">
                    <div class="todo-checkbox ${todo.status === 'complete' ? 'checked' : ''}"
                        onclick="toggleTodo('${todo.id}')">
                        ${todo.status === 'complete' ? '&#10003;' : ''}
                    </div>
                    <div class="todo-content">
                        <div class="todo-title ${todo.status === 'complete' ? 'completed' : ''}">${todo.title}</div>
                        <div class="todo-meta">
                            <span>${todo.owner}</span>
                            <span>Due: ${formatDate(todo.dueDate)}</span>
                            ${todo.carriedForwardCount > 0 ? `<span class="carried-badge">Carried ${todo.carriedForwardCount}x</span>` : ''}
                        </div>
                    </div>
                    <button class="btn btn-sm btn-secondary" onclick="deleteTodo('${todo.id}')">&#10005;</button>
                </div>
            `).join('');

            document.getElementById('todosList').innerHTML = html || '<div class="empty-state"><div class="empty-state-icon">&#10003;</div><p>No to-dos</p></div>';
        }

        // Vision Rendering
        function renderVision() {
            const vision = appData.vision;
            const html = `
                <!-- Core Focus -->
                <div class="vision-section">
                    <div class="vision-header">
                        <div class="vision-icon">&#9733;</div>
                        <div>
                            <div class="vision-title">Core Focus</div>
                            <div class="vision-subtitle">Why we exist</div>
                        </div>
                    </div>
                    <div class="vision-grid">
                        <div>
                            <h4 style="color: var(--accent-gold); margin-bottom: 0.5rem;">Purpose</h4>
                            <p>${vision.coreFocus?.purpose || ''}</p>
                        </div>
                        <div>
                            <h4 style="color: var(--accent-gold); margin-bottom: 0.5rem;">Passion</h4>
                            <p>${vision.coreFocus?.passion || ''}</p>
                        </div>
                        <div style="grid-column: 1 / -1;">
                            <h4 style="color: var(--accent-gold); margin-bottom: 0.5rem;">Niche</h4>
                            <p>${vision.coreFocus?.niche || ''}</p>
                        </div>
                    </div>
                </div>

                <!-- 10-Year Target -->
                <div class="vision-section">
                    <div class="vision-header">
                        <div class="vision-icon">&#127775;</div>
                        <div>
                            <div class="vision-title">10-Year Target</div>
                            <div class="vision-subtitle">${vision.tenYear?.target || '2036'}</div>
                        </div>
                    </div>
                    <div class="vision-content">
                        ${vision.tenYear?.description || ''}
                    </div>
                </div>

                <!-- 3-Year Picture -->
                <div class="vision-section">
                    <div class="vision-header">
                        <div class="vision-icon">&#128200;</div>
                        <div>
                            <div class="vision-title">3-Year Picture</div>
                            <div class="vision-subtitle">End of ${vision.threeYear?.target || '2029'}</div>
                        </div>
                    </div>
                    <div class="vision-grid">
                        <div class="vision-stat">
                            <div class="vision-stat-value">${vision.threeYear?.revenue || '£10M'}</div>
                            <div class="vision-stat-label">Annual Revenue</div>
                        </div>
                        <div class="vision-stat">
                            <div class="vision-stat-value">${vision.threeYear?.customers || '200,000'}</div>
                            <div class="vision-stat-label">Customers Annually</div>
                        </div>
                        <div class="vision-stat">
                            <div class="vision-stat-value">${vision.threeYear?.team?.total || '30-33'}</div>
                            <div class="vision-stat-label">Team Members</div>
                        </div>
                        <div class="vision-stat">
                            <div class="vision-stat-value">${vision.threeYear?.metrics?.netMargin || '25%'}</div>
                            <div class="vision-stat-label">Net Margin</div>
                        </div>
                    </div>
                    <div style="margin-top: 1.5rem;">
                        <h4 style="margin-bottom: 0.75rem;">Geographic Distribution</h4>
                        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem;">
                            <div>
                                <div style="font-weight: 500;">UK</div>
                                <div style="color: var(--text-muted);">${vision.threeYear?.geography?.uk || '60%'}</div>
                            </div>
                            <div>
                                <div style="font-weight: 500;">North America</div>
                                <div style="color: var(--text-muted);">${vision.threeYear?.geography?.northAmerica || '17.5%'}</div>
                            </div>
                            <div>
                                <div style="font-weight: 500;">Australia</div>
                                <div style="color: var(--text-muted);">${vision.threeYear?.geography?.australia || '17.5%'}</div>
                            </div>
                            <div>
                                <div style="font-weight: 500;">Europe</div>
                                <div style="color: var(--text-muted);">${vision.threeYear?.geography?.europe || '5%'}</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 1-Year Plan -->
                <div class="vision-section">
                    <div class="vision-header">
                        <div class="vision-icon">&#128197;</div>
                        <div>
                            <div class="vision-title">1-Year Plan</div>
                            <div class="vision-subtitle">End of ${vision.oneYear?.target || '2026'}</div>
                        </div>
                    </div>
                    <div class="vision-grid">
                        <div class="vision-stat">
                            <div class="vision-stat-value">${vision.oneYear?.revenue || '£2.1M'}</div>
                            <div class="vision-stat-label">Revenue Target</div>
                        </div>
                        <div class="vision-stat">
                            <div class="vision-stat-value">${vision.oneYear?.split?.brightIvy || '71%'}</div>
                            <div class="vision-stat-label">Bright Ivy</div>
                        </div>
                        <div class="vision-stat">
                            <div class="vision-stat-value">${vision.oneYear?.split?.displayChamp || '29%'}</div>
                            <div class="vision-stat-label">Display Champ</div>
                        </div>
                        <div class="vision-stat">
                            <div class="vision-stat-value">${vision.oneYear?.profit?.netMargin || '25%'}</div>
                            <div class="vision-stat-label">Net Margin</div>
                        </div>
                    </div>
                    <div style="margin-top: 1.5rem;">
                        <h4 style="margin-bottom: 0.75rem;">Quarterly Targets</h4>
                        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem;">
                            <div style="padding: 0.75rem; background: var(--light-bg);">
                                <div style="font-weight: 500;">Q1</div>
                                <div style="font-family: var(--font-mono);">${vision.oneYear?.quarterly?.q1 || '£420K'}</div>
                            </div>
                            <div style="padding: 0.75rem; background: var(--light-bg);">
                                <div style="font-weight: 500;">Q2</div>
                                <div style="font-family: var(--font-mono);">${vision.oneYear?.quarterly?.q2 || '£420K'}</div>
                            </div>
                            <div style="padding: 0.75rem; background: var(--light-bg);">
                                <div style="font-weight: 500;">Q3</div>
                                <div style="font-family: var(--font-mono);">${vision.oneYear?.quarterly?.q3 || '£420K'}</div>
                            </div>
                            <div style="padding: 0.75rem; background: var(--accent-gold); color: var(--forest-green);">
                                <div style="font-weight: 500;">Q4 Peak</div>
                                <div style="font-family: var(--font-mono);">${vision.oneYear?.quarterly?.q4 || '£840K'}</div>
                            </div>
                        </div>
                    </div>
                    ${vision.oneYear?.goals ? `
                    <div style="margin-top: 1.5rem;">
                        <h4 style="margin-bottom: 0.75rem;">2026 Goals</h4>
                        <div style="display: grid; gap: 1rem;">
                            ${vision.oneYear.goals.map(goal => `
                                <div style="padding: 1rem; border-left: 3px solid var(--accent-gold);">
                                    <div style="font-weight: 500; margin-bottom: 0.5rem;">${goal.title}</div>
                                    <ul style="margin: 0; padding-left: 1.25rem; color: var(--text-secondary);">
                                        ${goal.targets.map(t => `<li>${t}</li>`).join('')}
                                    </ul>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    ` : ''}
                </div>
            `;
            document.getElementById('visionContent').innerHTML = html;
        }

        // Helper Functions
        function calculateOverallRockProgress() {
            if (appData.rocks.length === 0) return 0;
            const total = appData.rocks.reduce((sum, rock) => sum + rock.progress, 0);
            return Math.round(total / appData.rocks.length);
        }

        function getStatusColor(status) {
            const colors = {
                'green': 'green', 'on-track': 'green',
                'yellow': 'yellow', 'at-risk': 'yellow',
                'red': 'red', 'off-track': 'red'
            };
            return colors[status] || 'green';
        }

        function formatStatus(status) {
            const labels = {
                'on-track': 'On Track',
                'at-risk': 'At Risk',
                'off-track': 'Off Track'
            };
            return labels[status] || status;
        }

        function formatDate(dateStr) {
            if (!dateStr) return '-';
            const date = new Date(dateStr);
            return date.toLocaleDateString('en-GB', { day: 'numeric', month: 'short' });
        }

        function generateSparkline(history = []) {
            if (!history || history.length < 2) return '<svg></svg>';
            const width = 60, height = 20;
            const max = Math.max(...history);
            const min = Math.min(...history);
            const range = max - min || 1;
            const points = history.map((val, i) => {
                const x = (i / (history.length - 1)) * width;
                const y = height - ((val - min) / range) * height;
                return `${x},${y}`;
            }).join(' ');
            return `<svg viewBox="0 0 ${width} ${height}"><polyline points="${points}" fill="none" stroke="var(--accent-gold)" stroke-width="1.5"/></svg>`;
        }

        function generateId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2);
        }

        // Navigation
        function navigateTo(page) {
            document.querySelectorAll('.page-view').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));

            document.getElementById(`page-${page}`).classList.add('active');
            document.querySelector(`[data-page="${page}"]`).classList.add('active');

            if (page === 'meeting') {
                startMeeting();
            }

            if (page === 'history') {
                renderMeetingHistory();
            }
        }

        // Event Listeners
        function setupEventListeners() {
            // Navigation
            document.querySelectorAll('.nav-item').forEach(item => {
                item.addEventListener('click', () => {
                    const page = item.dataset.page;
                    // Special handling for meeting nav item
                    if (page === 'meeting') {
                        const saved = localStorage.getItem(MEETING_STORAGE_KEY);
                        if (saved) {
                            try {
                                const data = JSON.parse(saved);
                                resumeMeeting(data);
                            } catch (e) {
                                startMeeting();
                            }
                        } else {
                            startMeeting();
                        }
                    } else {
                        navigateTo(page);
                    }
                });
            });

            // Filter tabs
            document.querySelectorAll('.filter-tab').forEach(tab => {
                tab.addEventListener('click', (e) => {
                    const parent = e.target.closest('.filter-tabs');
                    parent.querySelectorAll('.filter-tab').forEach(t => t.classList.remove('active'));
                    e.target.classList.add('active');

                    const filter = e.target.dataset.filter;
                    const page = document.querySelector('.page-view.active').id;

                    if (page === 'page-rocks') renderRocks(filter);
                    else if (page === 'page-issues') renderIssues(filter);
                    else if (page === 'page-todos') renderTodos(filter);
                });
            });

            // Dark mode toggle
            document.getElementById('darkModeToggle').addEventListener('click', toggleDarkMode);
        }

        // Keyboard Shortcuts
        function setupKeyboardShortcuts() {
            document.addEventListener('keydown', (e) => {
                if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.isContentEditable) return;

                switch(e.key.toLowerCase()) {
                    case 'd': navigateTo('dashboard'); break;
                    case 's': navigateTo('scorecard'); break;
                    case 'r': navigateTo('rocks'); break;
                    case 'i': navigateTo('issues'); break;
                    case 't': navigateTo('todos'); break;
                    case 'v': navigateTo('vision'); break;
                    case 'h': navigateTo('history'); break;
                    case 'm': startMeeting(); break;
                    case 'n':
                        const activePage = document.querySelector('.page-view.active').id;
                        if (activePage === 'page-issues') openIssueModal();
                        else if (activePage === 'page-todos') openTodoModal();
                        break;
                    case 'escape':
                        closeAllModals();
                        if (meetingActive) exitMeeting();
                        break;
                }
            });
        }

        // Dark Mode
        function toggleDarkMode() {
            document.body.classList.toggle('dark-mode');
            const isDark = document.body.classList.contains('dark-mode');
            document.getElementById('darkModeIcon').innerHTML = isDark ? '&#9728;' : '&#9790;';
            document.getElementById('darkModeText').textContent = isDark ? 'Light Mode' : 'Dark Mode';
            appData.settings.darkMode = isDark;
            saveData();
        }

        // Scorecard Functions
        function updateMetricValue(id, value) {
            const metric = appData.scorecard.metrics.find(m => m.id === id);
            if (metric) {
                metric.current = value;
                saveData();
                saveMetricToSupabase(metric);
            }
        }

        function updateMetricStatus(id, status) {
            const metric = appData.scorecard.metrics.find(m => m.id === id);
            if (metric) {
                metric.status = status;
                saveData();
                saveMetricToSupabase(metric);
                renderDashboard();
            }
        }

        function addWeeklyData() {
            showToast('Week data tracking - enter values in the Current column');
        }

        function dropToIssue(metricId) {
            const metric = appData.scorecard.metrics.find(m => m.id === metricId);
            if (metric) {
                const issue = {
                    id: generateId(),
                    title: `${metric.name} - Off Track`,
                    source: 'scorecard',
                    priority: appData.issues.length + 1,
                    status: 'open',
                    createdDate: new Date().toISOString().split('T')[0],
                    notes: `Dropped from scorecard. Goal: ${metric.goal}`,
                    linkedTodos: []
                };
                appData.issues.push(issue);
                saveData();
                saveIssueToSupabase(issue);
                showToast('Issue created from scorecard');
                renderIssues();
            }
        }

        // Rock Functions
        function updateRockProgress(id, value) {
            const rock = appData.rocks.find(r => r.id === id);
            if (rock) {
                rock.progress = parseInt(value);
                saveData();
                saveRockToSupabase(rock);
                renderDashboard();
            }
        }

        function updateRockStatus(id, status) {
            const rock = appData.rocks.find(r => r.id === id);
            if (rock) {
                rock.status = status;
                saveData();
                saveRockToSupabase(rock);
                renderRocks();
                renderDashboard();
            }
        }

        function toggleMilestone(rockId, milestoneId) {
            const rock = appData.rocks.find(r => r.id === rockId);
            if (rock) {
                const milestone = rock.milestones.find(m => m.id === milestoneId);
                if (milestone) {
                    milestone.completed = !milestone.completed;
                    // Auto-update progress
                    const completed = rock.milestones.filter(m => m.completed).length;
                    rock.progress = Math.round((completed / rock.milestones.length) * 100);
                    saveData();
                    saveRockToSupabase(rock);
                    renderRocks();
                    renderDashboard();
                }
            }
        }

        function openRockModal() {
            document.getElementById('rockModal').classList.add('active');
        }

        function closeRockModal() {
            document.getElementById('rockModal').classList.remove('active');
        }

        function saveRock() {
            const title = document.getElementById('rockTitle').value.trim();
            if (!title) return showToast('Please enter a rock title');

            const rock = {
                id: generateId(),
                title: title,
                owner: document.getElementById('rockOwner').value,
                progress: 0,
                status: 'on-track',
                dueDate: document.getElementById('rockDueDate').value,
                milestones: [],
                notes: ''
            };

            appData.rocks.push(rock);
            saveData();
            saveRockToSupabase(rock);
            closeRockModal();
            renderRocks();
            renderDashboard();
            showToast('Rock added');

            // Clear form
            document.getElementById('rockTitle').value = '';
        }

        // Issue Functions
        function openIssueModal(id = null) {
            editingIssueId = id;
            document.getElementById('issueModalTitle').textContent = id ? 'Edit Issue' : 'Add Issue';

            if (id) {
                const issue = appData.issues.find(i => i.id === id);
                if (issue) {
                    document.getElementById('issueTitle').value = issue.title;
                    document.getElementById('issueSource').value = issue.source;
                    document.getElementById('issueNotes').value = issue.notes || '';
                }
            } else {
                document.getElementById('issueTitle').value = '';
                document.getElementById('issueSource').value = 'other';
                document.getElementById('issueNotes').value = '';
            }

            document.getElementById('issueModal').classList.add('active');
        }

        function closeIssueModal() {
            document.getElementById('issueModal').classList.remove('active');
            editingIssueId = null;
        }

        function saveIssue() {
            const title = document.getElementById('issueTitle').value.trim();
            if (!title) return showToast('Please enter an issue title');

            let issueToSave;
            if (editingIssueId) {
                const issue = appData.issues.find(i => i.id === editingIssueId);
                if (issue) {
                    issue.title = title;
                    issue.source = document.getElementById('issueSource').value;
                    issue.notes = document.getElementById('issueNotes').value;
                    issueToSave = issue;
                }
            } else {
                const issue = {
                    id: generateId(),
                    title: title,
                    source: document.getElementById('issueSource').value,
                    priority: appData.issues.length + 1,
                    status: 'open',
                    createdDate: new Date().toISOString().split('T')[0],
                    notes: document.getElementById('issueNotes').value,
                    linkedTodos: []
                };
                appData.issues.push(issue);
                issueToSave = issue;
            }

            saveData();
            if (issueToSave) saveIssueToSupabase(issueToSave);
            closeIssueModal();
            renderIssues();
            renderDashboard();
            showToast(editingIssueId ? 'Issue updated' : 'Issue added');
        }

        function updateIssueStatus(id, status) {
            const issue = appData.issues.find(i => i.id === id);
            if (issue) {
                issue.status = status;
                saveData();
                saveIssueToSupabase(issue);
                renderIssues();
                renderDashboard();
            }
        }

        function deleteIssue(id) {
            appData.issues = appData.issues.filter(i => i.id !== id);
            saveData();
            deleteIssueFromSupabase(id);
            renderIssues();
            renderDashboard();
            showToast('Issue deleted');
        }

        function createTodoFromIssue(issueId) {
            const issue = appData.issues.find(i => i.id === issueId);
            if (issue) {
                document.getElementById('todoTitle').value = issue.title;
                openTodoModal();
            }
        }

        // Drag and Drop for Issues
        let draggedItem = null;

        function dragStart(e) {
            draggedItem = e.target;
            e.target.classList.add('dragging');
        }

        function dragOver(e) {
            e.preventDefault();
        }

        function drop(e) {
            e.preventDefault();
            const target = e.target.closest('.issue-item');
            if (target && draggedItem !== target) {
                const container = document.getElementById('issuesList');
                const items = [...container.querySelectorAll('.issue-item')];
                const draggedIdx = items.indexOf(draggedItem);
                const targetIdx = items.indexOf(target);

                if (draggedIdx < targetIdx) {
                    target.after(draggedItem);
                } else {
                    target.before(draggedItem);
                }

                // Update priorities in data
                const newOrder = [...container.querySelectorAll('.issue-item')].map(el => el.dataset.id);
                newOrder.forEach((id, idx) => {
                    const issue = appData.issues.find(i => i.id === id);
                    if (issue) issue.priority = idx + 1;
                });

                appData.issues.sort((a, b) => a.priority - b.priority);
                saveData();
                saveIssuesPrioritiesToSupabase();
            }
            draggedItem.classList.remove('dragging');
            draggedItem = null;
        }

        // Todo Functions
        function openTodoModal(id = null) {
            editingTodoId = id;
            document.getElementById('todoModalTitle').textContent = id ? 'Edit To-Do' : 'Add To-Do';

            if (id) {
                const todo = appData.todos.find(t => t.id === id);
                if (todo) {
                    document.getElementById('todoTitle').value = todo.title;
                    document.getElementById('todoOwner').value = todo.owner;
                    document.getElementById('todoDueDate').value = todo.dueDate;
                    document.getElementById('todoNotes').value = todo.notes || '';
                }
            } else {
                document.getElementById('todoTitle').value = '';
                document.getElementById('todoOwner').value = 'Joel';
                document.getElementById('todoDueDate').value = getNextMonday();
                document.getElementById('todoNotes').value = '';
            }

            document.getElementById('todoModal').classList.add('active');
        }

        function closeTodoModal() {
            document.getElementById('todoModal').classList.remove('active');
            editingTodoId = null;
        }

        function saveTodo() {
            const title = document.getElementById('todoTitle').value.trim();
            if (!title) return showToast('Please enter a to-do');

            let todoToSave;
            if (editingTodoId) {
                const todo = appData.todos.find(t => t.id === editingTodoId);
                if (todo) {
                    todo.title = title;
                    todo.owner = document.getElementById('todoOwner').value;
                    todo.dueDate = document.getElementById('todoDueDate').value;
                    todo.notes = document.getElementById('todoNotes').value;
                    todoToSave = todo;
                }
            } else {
                const todo = {
                    id: generateId(),
                    title: title,
                    owner: document.getElementById('todoOwner').value,
                    dueDate: document.getElementById('todoDueDate').value,
                    status: 'pending',
                    carriedForwardCount: 0,
                    notes: document.getElementById('todoNotes').value,
                    linkedIssueId: null
                };
                appData.todos.push(todo);
                todoToSave = todo;
            }

            saveData();
            if (todoToSave) saveTodoToSupabase(todoToSave);
            closeTodoModal();
            renderTodos();
            showToast(editingTodoId ? 'To-do updated' : 'To-do added');
        }

        function toggleTodo(id) {
            const todo = appData.todos.find(t => t.id === id);
            if (todo) {
                if (todo.status === 'pending') {
                    todo.status = 'complete';
                } else {
                    todo.status = 'pending';
                    todo.carriedForwardCount++;
                }
                saveData();
                saveTodoToSupabase(todo);
                renderTodos();
            }
        }

        function deleteTodo(id) {
            appData.todos = appData.todos.filter(t => t.id !== id);
            deleteTodoFromSupabase(id);
            saveData();
            renderTodos();
            showToast('To-do deleted');
        }

        function getNextMonday() {
            const today = new Date();
            const dayOfWeek = today.getDay();
            const daysUntilMonday = dayOfWeek === 0 ? 1 : 8 - dayOfWeek;
            const nextMonday = new Date(today);
            nextMonday.setDate(today.getDate() + daysUntilMonday);
            return nextMonday.toISOString().split('T')[0];
        }

        // Meeting Mode Functions
        // Check for saved meeting on page load - clears old meetings
        function checkForSavedMeeting() {
            const saved = localStorage.getItem(MEETING_STORAGE_KEY);
            if (saved) {
                try {
                    const data = JSON.parse(saved);
                    // Check if meeting is from today
                    const savedDate = new Date(data.startTime).toDateString();
                    const today = new Date().toDateString();
                    if (savedDate !== today) {
                        // Old meeting, clear it
                        localStorage.removeItem(MEETING_STORAGE_KEY);
                        hidePausedMeetingBanner();
                    }
                    // If from today, banner is already shown by renderDashboard
                } catch (e) {
                    localStorage.removeItem(MEETING_STORAGE_KEY);
                }
            }
        }

        function startMeeting(resume = false) {
            meetingActive = true;

            if (!resume) {
                // Fresh meeting
                meetingSection = 0;
                meetingStartTime = new Date().toISOString();
                meetingNotes = {};
            }

            document.getElementById('meetingMode').classList.add('active');
            renderMeetingSection();
            startSectionTimer();
            saveMeetingProgress();
        }

        function resumeMeeting(savedData) {
            meetingSection = savedData.section || 0;
            meetingStartTime = savedData.startTime;
            meetingNotes = savedData.notes || {};
            meetingSeconds = savedData.timerSeconds || meetingSections[meetingSection].duration * 60;
            startMeeting(true);
        }

        function saveMeetingProgress() {
            if (!meetingActive) return;

            const progressData = {
                section: meetingSection,
                startTime: meetingStartTime,
                timerSeconds: meetingSeconds,
                notes: meetingNotes,
                savedAt: new Date().toISOString()
            };
            localStorage.setItem(MEETING_STORAGE_KEY, JSON.stringify(progressData));
        }

        function clearMeetingProgress() {
            localStorage.removeItem(MEETING_STORAGE_KEY);
            meetingNotes = {};
            meetingStartTime = null;
            hidePausedMeetingBanner();
        }

        // Paused Meeting Banner Functions
        function showPausedMeetingBanner() {
            const saved = localStorage.getItem(MEETING_STORAGE_KEY);
            if (saved) {
                try {
                    const data = JSON.parse(saved);
                    const sectionName = meetingSections[data.section]?.name || 'Unknown';
                    const banner = document.getElementById('pausedMeetingBanner');
                    document.getElementById('pausedMeetingText').textContent =
                        `Meeting in progress (${sectionName} section)`;
                    banner.classList.add('visible');
                    // Also update nav item indicator
                    const navItem = document.getElementById('startMeetingNav');
                    if (navItem) navItem.classList.add('has-paused');
                } catch (e) {
                    hidePausedMeetingBanner();
                }
            } else {
                hidePausedMeetingBanner();
            }
        }

        function hidePausedMeetingBanner() {
            const banner = document.getElementById('pausedMeetingBanner');
            if (banner) banner.classList.remove('visible');
            const navItem = document.getElementById('startMeetingNav');
            if (navItem) navItem.classList.remove('has-paused');
        }

        function resumePausedMeeting() {
            const saved = localStorage.getItem(MEETING_STORAGE_KEY);
            if (saved) {
                try {
                    const data = JSON.parse(saved);
                    hidePausedMeetingBanner();
                    resumeMeeting(data);
                } catch (e) {
                    showToast('Could not resume meeting. Starting fresh.');
                    startMeeting();
                }
            }
        }

        function discardPausedMeeting() {
            if (confirm('Discard the paused meeting? This cannot be undone.')) {
                clearMeetingProgress();
                showToast('Meeting discarded.');
            }
        }

        function pauseMeeting() {
            // Save progress and exit without ending the meeting
            saveMeetingProgress();
            meetingActive = false;
            clearInterval(meetingTimer);
            document.getElementById('meetingMode').classList.remove('active');
            showPausedMeetingBanner();
            showToast('Meeting paused. You can resume anytime.');
        }

        function exitMeeting() {
            if (meetingSection < meetingSections.length - 1) {
                // Not at the end - ask if they want to save
                if (confirm('Save meeting progress to resume later?')) {
                    pauseMeeting();
                    return;
                }
            }
            // End without saving
            meetingActive = false;
            clearInterval(meetingTimer);
            clearMeetingProgress();
            document.getElementById('meetingMode').classList.remove('active');
        }

        function renderMeetingSection() {
            const section = meetingSections[meetingSection];
            document.getElementById('meetingSectionName').textContent = section.name;

            // Update progress indicators
            const progressHtml = meetingSections.map((s, i) => {
                let cls = 'meeting-progress-segment';
                if (i < meetingSection) cls += ' completed';
                else if (i === meetingSection) cls += ' active';
                return `<div class="${cls}" title="${s.name}"></div>`;
            }).join('');
            document.getElementById('meetingProgress').innerHTML = progressHtml;

            // Render section content
            let contentHtml = `
                <div class="meeting-section-title">${section.name}</div>
                <div class="meeting-section-time">${section.duration} minutes - ${section.description}</div>
            `;

            switch(section.name) {
                case 'Segue':
                    contentHtml += `
                        <div class="card" style="margin-bottom: 1rem;">
                            <h4 style="margin-bottom: 1rem;">Share Good News</h4>
                            <p style="color: var(--text-secondary);">Personal and professional wins from the past week.</p>
                            <div style="margin-top: 1rem; display: grid; gap: 1rem; grid-template-columns: 1fr 1fr;">
                                <div style="padding: 1rem; background: var(--light-bg);">
                                    <div style="font-weight: 500; margin-bottom: 0.5rem;">Joel</div>
                                    <textarea class="form-textarea" placeholder="What's your good news?"></textarea>
                                </div>
                                <div style="padding: 1rem; background: var(--light-bg);">
                                    <div style="font-weight: 500; margin-bottom: 0.5rem;">Lee</div>
                                    <textarea class="form-textarea" placeholder="What's your good news?"></textarea>
                                </div>
                            </div>
                        </div>
                    `;
                    break;

                case 'Scorecard':
                    contentHtml += `<div class="card"><div class="table-container"><table>
                        <thead><tr><th>Metric</th><th>Owner</th><th>Goal</th><th>Status</th></tr></thead>
                        <tbody>
                            ${appData.scorecard.metrics.map(m => `
                                <tr>
                                    <td>${m.name}</td>
                                    <td>${m.owner}</td>
                                    <td>${m.goal}</td>
                                    <td><span class="status-badge status-${m.status}"><span class="status-dot ${m.status}"></span>${m.status}</span></td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table></div></div>`;
                    break;

                case 'Rock Review':
                    contentHtml += `<div class="rocks-grid">
                        ${appData.rocks.map(rock => {
                            const completedMilestones = rock.milestones.filter(m => m.completed).length;
                            const totalMilestones = rock.milestones.length;
                            return `
                            <div class="rock-card">
                                <div class="rock-header">
                                    <div>
                                        <div class="rock-title">${rock.title}</div>
                                        <div class="rock-owner">${rock.owner}</div>
                                    </div>
                                    <span class="status-badge status-${getStatusColor(rock.status)}">${formatStatus(rock.status)}</span>
                                </div>
                                <div class="progress-bar" style="margin-top: 1rem;">
                                    <div class="progress-fill ${getStatusColor(rock.status)}" style="width: ${rock.progress}%;"></div>
                                </div>
                                <div style="display: flex; justify-content: space-between; margin-top: 0.25rem;">
                                    <span style="font-size: 0.8rem; color: var(--text-muted);">Milestones: ${completedMilestones}/${totalMilestones}</span>
                                    <span style="font-family: var(--font-mono);">${rock.progress}%</span>
                                </div>
                                <div class="rock-milestones" style="margin-top: 0.75rem; padding-top: 0.75rem;">
                                    ${rock.milestones.map(m => `
                                        <div class="milestone-item">
                                            <div class="milestone-checkbox ${m.completed ? 'checked' : ''}"
                                                onclick="toggleMilestone('${rock.id}', '${m.id}'); renderMeetingSection();">
                                                ${m.completed ? '&#10003;' : ''}
                                            </div>
                                            <span class="milestone-text ${m.completed ? 'completed' : ''}">${m.text}</span>
                                        </div>
                                    `).join('')}
                                </div>
                                <div style="margin-top: 0.75rem;">
                                    <select class="form-select" style="width: 100%;" onchange="updateRockStatus('${rock.id}', this.value); renderMeetingSection();">
                                        <option value="on-track" ${rock.status === 'on-track' ? 'selected' : ''}>On Track</option>
                                        <option value="at-risk" ${rock.status === 'at-risk' ? 'selected' : ''}>At Risk</option>
                                        <option value="off-track" ${rock.status === 'off-track' ? 'selected' : ''}>Off Track</option>
                                    </select>
                                </div>
                            </div>
                        `}).join('')}
                    </div>`;
                    break;

                case 'Headlines':
                    contentHtml += `
                        <div class="card" style="margin-bottom: 1rem;">
                            <h4 style="margin-bottom: 1rem;">Customer Headlines</h4>
                            <textarea class="form-textarea" placeholder="Customer wins, feedback, complaints..."></textarea>
                        </div>
                        <div class="card">
                            <h4 style="margin-bottom: 1rem;">Employee Headlines</h4>
                            <textarea class="form-textarea" placeholder="Team updates, kudos, concerns..."></textarea>
                        </div>
                    `;
                    break;

                case 'To-Do Review':
                    const pendingTodos = appData.todos.filter(t => t.status === 'pending');
                    contentHtml += `
                        <div class="card">
                            <h4 style="margin-bottom: 1rem;">Last Week's Commitments</h4>
                            ${pendingTodos.length > 0 ? pendingTodos.map(todo => `
                                <div class="todo-item">
                                    <div class="todo-checkbox ${todo.status === 'complete' ? 'checked' : ''}"
                                        onclick="toggleTodo('${todo.id}'); renderMeetingSection();">
                                        ${todo.status === 'complete' ? '&#10003;' : ''}
                                    </div>
                                    <div class="todo-content">
                                        <div class="todo-title">${todo.title}</div>
                                        <div class="todo-meta"><span>${todo.owner}</span></div>
                                    </div>
                                </div>
                            `).join('') : '<p style="color: var(--text-muted);">All to-dos complete!</p>'}
                        </div>
                    `;
                    break;

                case 'IDS':
                    const openIssues = appData.issues.filter(i => i.status === 'open');
                    contentHtml += `
                        <div class="card" style="margin-bottom: 1rem;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                                <h4>Issues to Solve</h4>
                                <button class="btn btn-primary btn-sm" onclick="openIssueModal()">+ Add Issue</button>
                            </div>
                            <div class="issues-list">
                                ${openIssues.map((issue, i) => `
                                    <div class="issue-item">
                                        <div class="issue-priority">${i + 1}</div>
                                        <div class="issue-content">
                                            <div class="issue-title">${issue.title}</div>
                                            <div class="issue-meta"><span class="issue-source">${issue.source}</span></div>
                                        </div>
                                        <div class="issue-actions">
                                            <button class="btn btn-sm btn-success" onclick="updateIssueStatus('${issue.id}', 'resolved'); renderMeetingSection();">Solved</button>
                                            <button class="btn btn-sm btn-secondary" onclick="createTodoFromIssue('${issue.id}')">&#8594; To-Do</button>
                                        </div>
                                    </div>
                                `).join('')}
                                ${openIssues.length === 0 ? '<p style="color: var(--text-muted); padding: 1rem;">No open issues!</p>' : ''}
                            </div>
                        </div>
                    `;
                    break;

                case 'Conclude':
                    contentHtml += `
                        <div class="card" style="margin-bottom: 1rem;">
                            <h4 style="margin-bottom: 1rem;">Meeting Recap</h4>
                            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; margin-bottom: 1.5rem;">
                                <div style="padding: 1rem; background: var(--light-bg); text-align: center;">
                                    <div style="font-size: 1.5rem; font-weight: 600;">${appData.issues.filter(i => i.status === 'resolved').length}</div>
                                    <div style="font-size: 0.8rem; color: var(--text-muted);">Issues Solved</div>
                                </div>
                                <div style="padding: 1rem; background: var(--light-bg); text-align: center;">
                                    <div style="font-size: 1.5rem; font-weight: 600;">${appData.todos.filter(t => t.status === 'pending').length}</div>
                                    <div style="font-size: 0.8rem; color: var(--text-muted);">New To-Dos</div>
                                </div>
                                <div style="padding: 1rem; background: var(--light-bg); text-align: center;">
                                    <div style="font-size: 1.5rem; font-weight: 600;">${appData.rocks.filter(r => r.status === 'on-track').length}/${appData.rocks.length}</div>
                                    <div style="font-size: 0.8rem; color: var(--text-muted);">Rocks On Track</div>
                                </div>
                            </div>
                            <button class="btn btn-gold" onclick="showRatingModal()" style="width: 100%;">Rate This Meeting</button>
                        </div>
                    `;
                    break;
            }

            document.getElementById('meetingBody').innerHTML = contentHtml;

            // Update nav buttons
            document.getElementById('prevSection').style.visibility = meetingSection === 0 ? 'hidden' : 'visible';
            document.getElementById('nextSection').textContent = meetingSection === meetingSections.length - 1 ? 'Finish' : 'Next →';
        }

        function startSectionTimer(preserveTime = false) {
            clearInterval(meetingTimer);
            if (!preserveTime) {
                meetingSeconds = meetingSections[meetingSection].duration * 60;
            }
            updateTimerDisplay();

            meetingTimer = setInterval(() => {
                meetingSeconds--;
                updateTimerDisplay();

                // Auto-save every 30 seconds
                if (meetingSeconds % 30 === 0) {
                    saveMeetingProgress();
                }

                if (meetingSeconds === 60) {
                    showToast('1 minute remaining!');
                } else if (meetingSeconds === 0) {
                    showToast('Time\'s up!');
                }
            }, 1000);
        }

        function updateTimerDisplay() {
            const minutes = Math.floor(Math.abs(meetingSeconds) / 60);
            const seconds = Math.abs(meetingSeconds) % 60;
            const display = `${meetingSeconds < 0 ? '-' : ''}${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
            document.getElementById('meetingTimer').textContent = display;
            document.getElementById('meetingTimer').style.color = meetingSeconds < 0 ? 'var(--danger-red)' : 'var(--accent-gold)';
        }

        function nextMeetingSection() {
            if (meetingSection < meetingSections.length - 1) {
                meetingSection++;
                renderMeetingSection();
                startSectionTimer();
                saveMeetingProgress();
            } else {
                showRatingModal();
            }
        }

        function prevMeetingSection() {
            if (meetingSection > 0) {
                meetingSection--;
                renderMeetingSection();
                startSectionTimer();
                saveMeetingProgress();
            }
        }

        function showRatingModal() {
            const buttons = Array.from({length: 10}, (_, i) => i + 1).map(n => `
                <button class="btn btn-secondary" style="width: 48px; height: 48px; font-size: 1.25rem;"
                    onclick="rateMeeting(${n})">${n}</button>
            `).join('');
            document.getElementById('ratingButtons').innerHTML = buttons;
            document.getElementById('ratingModal').classList.add('active');
        }

        function rateMeeting(rating) {
            const meeting = {
                id: generateId(),
                date: meetingStartTime || new Date().toISOString(),
                rating: rating,
                issuesSolved: appData.issues.filter(i => i.status === 'resolved').length,
                todosCreated: appData.todos.filter(t => t.status === 'pending').length
            };
            appData.meetings.push(meeting);
            saveData();
            saveMeetingToSupabase(meeting);

            // Clear meeting progress - meeting is complete
            clearMeetingProgress();

            document.getElementById('ratingModal').classList.remove('active');
            showToast(`Meeting rated ${rating}/10. Great work!`);

            setTimeout(() => {
                meetingActive = false;
                clearInterval(meetingTimer);
                document.getElementById('meetingMode').classList.remove('active');
            }, 1500);
        }

        // Utility Functions
        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.add('active');
            setTimeout(() => toast.classList.remove('active'), 3000);
        }

        function closeAllModals() {
            document.querySelectorAll('.modal-overlay').forEach(m => m.classList.remove('active'));
        }

        // ============================================
        // Enhanced Rock Editing Functions
        // ============================================

        let editingRockMilestones = [];

        function openEditRockModal(rockId) {
            const rock = appData.rocks.find(r => r.id === rockId);
            if (!rock) return;

            document.getElementById('editRockId').value = rockId;
            document.getElementById('editRockTitle').value = rock.title;
            document.getElementById('editRockNotes').value = rock.notes || '';
            document.getElementById('editRockOwner').value = rock.owner;
            document.getElementById('editRockDueDate').value = rock.dueDate;
            document.getElementById('editRockStatus').value = rock.status;

            // Copy milestones for editing
            editingRockMilestones = rock.milestones.map(m => ({...m}));
            renderEditRockMilestones();

            document.getElementById('editRockModal').classList.add('active');
        }

        function closeEditRockModal() {
            document.getElementById('editRockModal').classList.remove('active');
            editingRockMilestones = [];
        }

        function renderEditRockMilestones() {
            const container = document.getElementById('editRockMilestones');
            if (editingRockMilestones.length === 0) {
                container.innerHTML = '<p style="color: var(--text-muted); font-size: 0.875rem;">No milestones yet. Add some to track progress.</p>';
                return;
            }

            container.innerHTML = editingRockMilestones.map((m, index) => `
                <div class="milestone-edit-item">
                    <input type="checkbox" ${m.completed ? 'checked' : ''} onchange="toggleEditMilestone(${index})">
                    <input type="text" class="form-input" value="${m.text}" onchange="updateMilestoneText(${index}, this.value)" style="flex: 1;">
                    <button class="btn btn-sm btn-secondary" onclick="deleteMilestoneFromEdit(${index})" title="Delete milestone">&#10005;</button>
                </div>
            `).join('');
        }

        function addMilestoneToEditModal() {
            editingRockMilestones.push({
                id: 'm-' + generateId(),
                text: '',
                completed: false
            });
            renderEditRockMilestones();
            // Focus the new input
            setTimeout(() => {
                const inputs = document.querySelectorAll('#editRockMilestones input[type="text"]');
                if (inputs.length > 0) inputs[inputs.length - 1].focus();
            }, 50);
        }

        function toggleEditMilestone(index) {
            editingRockMilestones[index].completed = !editingRockMilestones[index].completed;
        }

        function updateMilestoneText(index, text) {
            editingRockMilestones[index].text = text;
        }

        function deleteMilestoneFromEdit(index) {
            editingRockMilestones.splice(index, 1);
            renderEditRockMilestones();
        }

        function saveRockEdits() {
            const rockId = document.getElementById('editRockId').value;
            const rock = appData.rocks.find(r => r.id === rockId);
            if (!rock) return;

            const title = document.getElementById('editRockTitle').value.trim();
            if (!title) return showToast('Please enter a rock title');

            rock.title = title;
            rock.notes = document.getElementById('editRockNotes').value.trim();
            rock.owner = document.getElementById('editRockOwner').value;
            rock.dueDate = document.getElementById('editRockDueDate').value;
            rock.status = document.getElementById('editRockStatus').value;

            // Filter out empty milestones and update
            rock.milestones = editingRockMilestones.filter(m => m.text.trim() !== '');

            // Recalculate progress
            if (rock.milestones.length > 0) {
                const completed = rock.milestones.filter(m => m.completed).length;
                rock.progress = Math.round((completed / rock.milestones.length) * 100);
            }

            saveData();
            saveRockToSupabase(rock);
            closeEditRockModal();
            renderRocks();
            renderDashboard();
            showToast('Rock updated');
        }

        function deleteRock() {
            const rockId = document.getElementById('editRockId').value;
            if (!confirm('Are you sure you want to delete this rock?')) return;

            appData.rocks = appData.rocks.filter(r => r.id !== rockId);
            saveData();
            deleteRockFromSupabase(rockId);
            closeEditRockModal();
            renderRocks();
            renderDashboard();
            showToast('Rock deleted');
        }

        // ============================================
        // Scorecard Metric Editing Functions
        // ============================================

        function openEditMetricModal(metricId) {
            const metric = appData.scorecard.metrics.find(m => m.id === metricId);
            if (!metric) return;

            document.getElementById('editMetricId').value = metricId;
            document.getElementById('editMetricName').value = metric.name;
            document.getElementById('editMetricGoal').value = metric.goal;
            document.getElementById('editMetricOwner').value = metric.owner;
            document.getElementById('editMetricNotes').value = metric.notes || '';

            document.getElementById('editMetricModal').classList.add('active');
        }

        function closeEditMetricModal() {
            document.getElementById('editMetricModal').classList.remove('active');
        }

        function saveMetricEdits() {
            const metricId = document.getElementById('editMetricId').value;
            const metric = appData.scorecard.metrics.find(m => m.id === metricId);
            if (!metric) return;

            const name = document.getElementById('editMetricName').value.trim();
            if (!name) return showToast('Please enter a metric name');

            metric.name = name;
            metric.goal = document.getElementById('editMetricGoal').value.trim();
            metric.owner = document.getElementById('editMetricOwner').value;
            metric.notes = document.getElementById('editMetricNotes').value.trim();

            saveData();
            saveMetricToSupabase(metric);
            closeEditMetricModal();
            renderScorecard();
            renderDashboard();
            showToast('Metric updated');
        }

        // ============================================
        // Weekly Data Entry Functions
        // ============================================

        function addWeeklyData() {
            openWeeklyDataModal();
        }

        function openWeeklyDataModal() {
            const fieldsHtml = appData.scorecard.metrics.map(metric => `
                <div class="form-group">
                    <label class="form-label">${metric.name}</label>
                    <div style="display: flex; gap: 0.5rem; align-items: center;">
                        <input type="text" class="form-input" id="weekly-${metric.id}"
                            value="${metric.current || ''}" placeholder="Enter value">
                        <span style="color: var(--text-muted); font-size: 0.8rem;">Goal: ${metric.goal}</span>
                    </div>
                </div>
            `).join('');

            document.getElementById('weeklyDataFields').innerHTML = fieldsHtml;
            document.getElementById('weeklyDataModal').classList.add('active');
        }

        function closeWeeklyDataModal() {
            document.getElementById('weeklyDataModal').classList.remove('active');
        }

        function saveWeeklyData() {
            const weekDate = new Date().toISOString().split('T')[0];

            appData.scorecard.metrics.forEach(metric => {
                const input = document.getElementById(`weekly-${metric.id}`);
                if (input && input.value.trim()) {
                    metric.current = input.value.trim();

                    // Add to history
                    if (!metric.history) metric.history = [];
                    metric.history.push({
                        date: weekDate,
                        value: input.value.trim()
                    });

                    // Keep only last 12 weeks of history
                    if (metric.history.length > 12) {
                        metric.history = metric.history.slice(-12);
                    }
                }
            });

            saveData();
            closeWeeklyDataModal();
            renderScorecard();
            renderDashboard();
            showToast('Weekly data saved');
        }

        // ============================================
        // Vision Editing Functions
        // ============================================

        let visionEditMode = false;

        function toggleVisionEditMode() {
            visionEditMode = !visionEditMode;
            const btn = document.getElementById('visionEditToggle');
            btn.innerHTML = visionEditMode ? '&#10003; Save Changes' : '&#9998; Edit';
            btn.className = visionEditMode ? 'btn btn-success' : 'btn btn-secondary';

            if (visionEditMode) {
                renderVisionEditMode();
            } else {
                saveVisionEdits();
                renderVision();
            }
        }

        function renderVisionEditMode() {
            const vision = appData.vision;
            const html = `
                <!-- Core Focus (Editable) -->
                <div class="vision-section">
                    <div class="vision-header">
                        <div class="vision-icon">&#9733;</div>
                        <div>
                            <div class="vision-title">Core Focus</div>
                            <div class="vision-subtitle">Why we exist</div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label" style="color: var(--accent-gold);">Purpose</label>
                        <textarea class="form-textarea vision-editable" id="edit-purpose">${vision.coreFocus?.purpose || ''}</textarea>
                    </div>
                    <div class="form-group">
                        <label class="form-label" style="color: var(--accent-gold);">Passion</label>
                        <textarea class="form-textarea vision-editable" id="edit-passion">${vision.coreFocus?.passion || ''}</textarea>
                    </div>
                    <div class="form-group">
                        <label class="form-label" style="color: var(--accent-gold);">Niche</label>
                        <textarea class="form-textarea vision-editable" id="edit-niche">${vision.coreFocus?.niche || ''}</textarea>
                    </div>
                </div>

                <!-- 10-Year Target (Editable) -->
                <div class="vision-section">
                    <div class="vision-header">
                        <div class="vision-icon">&#127775;</div>
                        <div>
                            <div class="vision-title">10-Year Target</div>
                            <div class="vision-subtitle">
                                <input type="text" class="form-input" id="edit-tenYear-target" value="${vision.tenYear?.target || '2036'}" style="width: 100px;">
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Description</label>
                        <textarea class="form-textarea vision-editable" id="edit-tenYear-description">${vision.tenYear?.description || ''}</textarea>
                    </div>
                </div>

                <!-- 3-Year Picture (Editable) -->
                <div class="vision-section">
                    <div class="vision-header">
                        <div class="vision-icon">&#128200;</div>
                        <div>
                            <div class="vision-title">3-Year Picture</div>
                            <div class="vision-subtitle">End of <input type="text" class="form-input" id="edit-threeYear-target" value="${vision.threeYear?.target || '2029'}" style="width: 80px; display: inline;"></div>
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem;">
                        <div class="form-group">
                            <label class="form-label">Revenue Target</label>
                            <input type="text" class="form-input" id="edit-threeYear-revenue" value="${vision.threeYear?.revenue || ''}">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Customers Annually</label>
                            <input type="text" class="form-input" id="edit-threeYear-customers" value="${vision.threeYear?.customers || ''}">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Team Size</label>
                            <input type="text" class="form-input" id="edit-threeYear-team" value="${vision.threeYear?.team?.total || ''}">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Net Margin</label>
                            <input type="text" class="form-input" id="edit-threeYear-netMargin" value="${vision.threeYear?.metrics?.netMargin || ''}">
                        </div>
                    </div>
                </div>

                <!-- 1-Year Plan (Editable) -->
                <div class="vision-section">
                    <div class="vision-header">
                        <div class="vision-icon">&#128197;</div>
                        <div>
                            <div class="vision-title">1-Year Plan</div>
                            <div class="vision-subtitle">End of <input type="text" class="form-input" id="edit-oneYear-target" value="${vision.oneYear?.target || '2026'}" style="width: 80px; display: inline;"></div>
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem;">
                        <div class="form-group">
                            <label class="form-label">Revenue Target</label>
                            <input type="text" class="form-input" id="edit-oneYear-revenue" value="${vision.oneYear?.revenue || ''}">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Net Margin</label>
                            <input type="text" class="form-input" id="edit-oneYear-netMargin" value="${vision.oneYear?.profit?.netMargin || ''}">
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem; margin-top: 1rem;">
                        <div class="form-group">
                            <label class="form-label">Q1</label>
                            <input type="text" class="form-input" id="edit-oneYear-q1" value="${vision.oneYear?.quarterly?.q1 || ''}">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Q2</label>
                            <input type="text" class="form-input" id="edit-oneYear-q2" value="${vision.oneYear?.quarterly?.q2 || ''}">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Q3</label>
                            <input type="text" class="form-input" id="edit-oneYear-q3" value="${vision.oneYear?.quarterly?.q3 || ''}">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Q4</label>
                            <input type="text" class="form-input" id="edit-oneYear-q4" value="${vision.oneYear?.quarterly?.q4 || ''}">
                        </div>
                    </div>
                </div>
            `;
            document.getElementById('visionContent').innerHTML = html;
        }

        function saveVisionEdits() {
            const vision = appData.vision;

            // Core Focus
            if (!vision.coreFocus) vision.coreFocus = {};
            vision.coreFocus.purpose = document.getElementById('edit-purpose')?.value || vision.coreFocus.purpose;
            vision.coreFocus.passion = document.getElementById('edit-passion')?.value || vision.coreFocus.passion;
            vision.coreFocus.niche = document.getElementById('edit-niche')?.value || vision.coreFocus.niche;

            // 10-Year
            if (!vision.tenYear) vision.tenYear = {};
            vision.tenYear.target = document.getElementById('edit-tenYear-target')?.value || vision.tenYear.target;
            vision.tenYear.description = document.getElementById('edit-tenYear-description')?.value || vision.tenYear.description;

            // 3-Year
            if (!vision.threeYear) vision.threeYear = {};
            vision.threeYear.target = document.getElementById('edit-threeYear-target')?.value || vision.threeYear.target;
            vision.threeYear.revenue = document.getElementById('edit-threeYear-revenue')?.value || vision.threeYear.revenue;
            vision.threeYear.customers = document.getElementById('edit-threeYear-customers')?.value || vision.threeYear.customers;
            if (!vision.threeYear.team) vision.threeYear.team = {};
            vision.threeYear.team.total = document.getElementById('edit-threeYear-team')?.value || vision.threeYear.team.total;
            if (!vision.threeYear.metrics) vision.threeYear.metrics = {};
            vision.threeYear.metrics.netMargin = document.getElementById('edit-threeYear-netMargin')?.value || vision.threeYear.metrics.netMargin;

            // 1-Year
            if (!vision.oneYear) vision.oneYear = {};
            vision.oneYear.target = document.getElementById('edit-oneYear-target')?.value || vision.oneYear.target;
            vision.oneYear.revenue = document.getElementById('edit-oneYear-revenue')?.value || vision.oneYear.revenue;
            if (!vision.oneYear.profit) vision.oneYear.profit = {};
            vision.oneYear.profit.netMargin = document.getElementById('edit-oneYear-netMargin')?.value || vision.oneYear.profit.netMargin;
            if (!vision.oneYear.quarterly) vision.oneYear.quarterly = {};
            vision.oneYear.quarterly.q1 = document.getElementById('edit-oneYear-q1')?.value || vision.oneYear.quarterly.q1;
            vision.oneYear.quarterly.q2 = document.getElementById('edit-oneYear-q2')?.value || vision.oneYear.quarterly.q2;
            vision.oneYear.quarterly.q3 = document.getElementById('edit-oneYear-q3')?.value || vision.oneYear.quarterly.q3;
            vision.oneYear.quarterly.q4 = document.getElementById('edit-oneYear-q4')?.value || vision.oneYear.quarterly.q4;

            saveData();
            saveVisionToSupabase();
            showToast('Vision updated');
        }

        // ============================================
        // Meeting History Functions
        // ============================================

        function renderMeetingHistory() {
            const meetings = appData.meetings || [];
            const stats = calculateMeetingStats();

            if (meetings.length === 0) {
                document.getElementById('historyContent').innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">&#128200;</div>
                        <p>No meetings recorded yet</p>
                        <p style="font-size: 0.875rem; color: var(--text-muted);">Start a Level 10 meeting and rate it to see history here.</p>
                        <button class="btn btn-primary" style="margin-top: 1rem;" onclick="startMeeting()">Start Level 10 Meeting</button>
                    </div>
                `;
                return;
            }

            // Calculate rating distribution for chart
            const maxRating = Math.max(...meetings.map(m => m.rating));

            const html = `
                <!-- Stats -->
                <div class="history-stats">
                    <div class="history-stat">
                        <div class="history-stat-value">${stats.totalMeetings}</div>
                        <div class="history-stat-label">Total Meetings</div>
                    </div>
                    <div class="history-stat">
                        <div class="history-stat-value">${stats.avgRating}</div>
                        <div class="history-stat-label">Average Rating</div>
                    </div>
                    <div class="history-stat">
                        <div class="history-stat-value">${stats.totalIssuesSolved}</div>
                        <div class="history-stat-label">Issues Solved</div>
                    </div>
                    <div class="history-stat">
                        <div class="history-stat-value">${stats.totalTodosCreated}</div>
                        <div class="history-stat-label">To-Dos Created</div>
                    </div>
                </div>

                <!-- Rating Trend Chart -->
                <div class="card" style="margin-bottom: 2rem;">
                    <div class="card-header">
                        <span class="card-title">Rating Trend</span>
                    </div>
                    <div class="rating-chart">
                        ${meetings.map(m => {
                            const height = (m.rating / 10) * 100;
                            return `<div class="rating-bar" style="height: ${height}%;" data-rating="${m.rating}" title="${formatDate(m.date)}: ${m.rating}/10"></div>`;
                        }).join('')}
                    </div>
                </div>

                <!-- Meeting History List -->
                <div class="card">
                    <div class="card-header">
                        <span class="card-title">Meeting History</span>
                    </div>
                    ${meetings.slice().reverse().map(meeting => {
                        const ratingClass = meeting.rating >= 8 ? 'high' : meeting.rating >= 6 ? 'medium' : 'low';
                        return `
                            <div class="meeting-history-card" data-meeting-id="${meeting.id}">
                                <div class="meeting-rating ${ratingClass}">${meeting.rating}</div>
                                <div style="flex: 1;">
                                    <div style="font-weight: 500;">Level 10 Meeting</div>
                                    <div style="font-size: 0.8rem; color: var(--text-muted);">
                                        ${formatDateLong(meeting.date)}
                                    </div>
                                    ${meeting.notes ? `<div class="meeting-notes" title="${meeting.notes}">${meeting.notes}</div>` : ''}
                                </div>
                                <div style="text-align: right; font-size: 0.8rem; color: var(--text-muted);">
                                    <div>${meeting.issuesSolved || 0} issues solved</div>
                                    <div>${meeting.todosCreated || 0} to-dos created</div>
                                </div>
                                <div class="meeting-actions">
                                    <button class="btn btn-icon btn-secondary" onclick="openEditMeetingModal('${meeting.id}')" title="Edit meeting">&#9998;</button>
                                    <button class="btn btn-icon btn-secondary" onclick="confirmDeleteMeeting('${meeting.id}')" title="Delete meeting" style="color: var(--danger-red);">&#128465;</button>
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;

            document.getElementById('historyContent').innerHTML = html;
        }

        // Meeting Edit/Delete Functions
        let editingMeetingRating = null;

        function openEditMeetingModal(meetingId) {
            const meeting = appData.meetings.find(m => m.id === meetingId);
            if (!meeting) {
                showToast('Meeting not found');
                return;
            }

            document.getElementById('editMeetingId').value = meetingId;

            // Format date for datetime-local input
            const date = new Date(meeting.date);
            const localDate = new Date(date.getTime() - date.getTimezoneOffset() * 60000);
            document.getElementById('editMeetingDate').value = localDate.toISOString().slice(0, 16);

            document.getElementById('editMeetingIssuesSolved').value = meeting.issuesSolved || 0;
            document.getElementById('editMeetingTodosCreated').value = meeting.todosCreated || 0;
            document.getElementById('editMeetingNotes').value = meeting.notes || '';

            // Render rating buttons
            editingMeetingRating = meeting.rating;
            renderEditMeetingRatingButtons();

            document.getElementById('editMeetingModal').classList.add('active');
        }

        function renderEditMeetingRatingButtons() {
            const buttonsHtml = Array.from({length: 10}, (_, i) => i + 1).map(num => {
                const isSelected = num === editingMeetingRating;
                return `<button class="btn ${isSelected ? 'btn-gold' : 'btn-secondary'}"
                    onclick="setEditMeetingRating(${num})"
                    style="min-width: 40px; ${isSelected ? '' : 'opacity: 0.7;'}">${num}</button>`;
            }).join('');
            document.getElementById('editMeetingRatingButtons').innerHTML = buttonsHtml;
        }

        function setEditMeetingRating(rating) {
            editingMeetingRating = rating;
            renderEditMeetingRatingButtons();
        }

        function closeEditMeetingModal() {
            document.getElementById('editMeetingModal').classList.remove('active');
            editingMeetingRating = null;
        }

        function saveMeetingEdits() {
            const meetingId = document.getElementById('editMeetingId').value;
            const meeting = appData.meetings.find(m => m.id === meetingId);
            if (!meeting) {
                showToast('Meeting not found');
                return;
            }

            const dateValue = document.getElementById('editMeetingDate').value;
            if (!dateValue) {
                showToast('Please select a date');
                return;
            }

            if (!editingMeetingRating) {
                showToast('Please select a rating');
                return;
            }

            meeting.date = new Date(dateValue).toISOString();
            meeting.rating = editingMeetingRating;
            meeting.issuesSolved = parseInt(document.getElementById('editMeetingIssuesSolved').value) || 0;
            meeting.todosCreated = parseInt(document.getElementById('editMeetingTodosCreated').value) || 0;
            meeting.notes = document.getElementById('editMeetingNotes').value.trim();

            saveData();
            saveMeetingToSupabase(meeting);
            closeEditMeetingModal();
            renderMeetingHistory();
            renderDashboard();
            showToast('Meeting updated successfully');
        }

        function confirmDeleteMeeting(meetingId) {
            if (confirm('Are you sure you want to delete this meeting? This action cannot be undone.')) {
                deleteMeetingById(meetingId);
            }
        }

        function deleteMeeting() {
            const meetingId = document.getElementById('editMeetingId').value;
            if (confirm('Are you sure you want to delete this meeting? This action cannot be undone.')) {
                deleteMeetingById(meetingId);
                closeEditMeetingModal();
            }
        }

        function deleteMeetingById(meetingId) {
            const index = appData.meetings.findIndex(m => m.id === meetingId);
            if (index === -1) {
                showToast('Meeting not found');
                return;
            }

            appData.meetings.splice(index, 1);
            saveData();
            deleteMeetingFromSupabase(meetingId);
            renderMeetingHistory();
            renderDashboard();
            showToast('Meeting deleted');
        }

        function formatDateLong(dateStr) {
            if (!dateStr) return '-';
            const date = new Date(dateStr);
            return date.toLocaleDateString('en-GB', {
                weekday: 'long',
                day: 'numeric',
                month: 'long',
                year: 'numeric'
            });
        }

        // Initialize on load
        document.addEventListener('DOMContentLoaded', init);

        // Try to restore from localStorage on reload
        window.addEventListener('beforeunload', () => {
            localStorage.setItem('eos-data-backup', JSON.stringify(appData));
        });
    </script>
</body>
</html>
